<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>[MDA] Obter Crédito Fundiário - Beneficiário (Etapa 1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>

  <style>
    :root{ --gap-x:20px; --gap-y:16px; }
    body{ background:#fafafa; padding:20px; }
    .btn-square{ border-radius:0 !important; }
    .btn-add{ background:#1976d2 !important; color:#fff !important; }
    .btn-danger{ background:#b71c1c !important; color:#fff !important; }
    .card-titlebar{ margin:0; line-height:1.5; background:#1976d2; color:#fff; padding:10px; text-align:center; }

    .form-section{ margin-top:1.2rem; padding:1rem; background:#fff; border:1px solid #ddd; border-radius:6px; }
    .form-section h5{ margin:0 0 .8rem 0; color:#1976d2; display:flex; align-items:center; gap:8px; }
    .form-section h6{ margin:.8rem 0 .5rem 0; color:#1976d2; }

    /* ====== GRADE ====== */
    .grid-3{ display:grid; grid-template-columns:repeat(3,minmax(260px,1fr)); gap:var(--gap-y) var(--gap-x); align-items:start; }
    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(260px,1fr)); gap:var(--gap-y) var(--gap-x); align-items:start; }
    .grid-1{ display:grid; grid-template-columns:1fr; gap:var(--gap-y) var(--gap-x); }
    .field label{ display:block; margin:0 0 6px 0; font-weight:600; color:#444; }

    /* Altura unificada e visual */
    .field input[type="text"],
    .field input[type="tel"],
    .field select.browser-default,
    .static-field,
    .choice{
      height:44px !important; line-height:44px !important;
      border:1px solid #cfd8dc !important; border-radius:4px !important;
      background:#fff !important; padding:0 10px !important; width:100%;
      box-sizing:border-box;
    }
    .static-field{ background:#f7f9fc !important; color:#37474f; font-weight:600; display:flex; align-items:center; }
    .choice{ display:flex; align-items:center; gap:16px; height:auto !important; border:none !important; background:transparent !important; padding:0 !important; }

    /* Tabela-resumo leve */
    .kv{ display:grid; grid-template-columns: 240px 1fr; gap:6px 12px; }
    .kv div{ padding:6px 10px; border:1px solid #e0e0e0; border-radius:6px; background:#fafcfe; }
    .kv .k{ font-weight:700; color:#455a64; background:#f3f7fb; }

    #mensagem{ display:none; padding:10px; border-radius:6px; font-weight:600; margin:12px 0; }
    .msg-sucesso{ background:#c8e6c9; color:#256029; }
    .msg-erro{ background:#ffcdd2; color:#b71c1c; }

    table.striped tbody tr:nth-child(odd){ background:#f9f9f9; }
    .action-btn{ background:none; border:none; cursor:pointer; margin:0 4px; color:#444; }
    .action-btn .material-icons{ font-size:20px; vertical-align:middle; }

    @media (max-width: 1100px){
      .grid-3{ grid-template-columns:repeat(2,minmax(260px,1fr)); }
    }
    @media (max-width: 760px){
      .grid-3, .grid-2{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<div class="container content">
  <div class="card">
    <div class="card-content" style="padding:0;">
      <h2 class="card-titlebar">Obter Crédito Fundiário — Beneficiário</h2>

      <div style="text-align:center; color:#145aa3; padding:.6rem;">
        <i class="material-icons" style="font-size:24px; vertical-align:middle;">label_important</i>
        <b>ETAPA 1</b>
      </div>

      <div class="section" style="padding:0 16px 16px 16px;">

        <div id="mensagem"></div>

        <!-- Seleção do Imóvel -->
        <div class="form-section">
          <h5><i class="material-icons">home</i>Seleção do Imóvel</h5>

          <div class="grid-3">
            <div class="field">
              <label for="selectImovel">Imóvel (SNCR) *</label>
              <select id="selectImovel" class="browser-default" required>
                <option value="" disabled selected>Selecione o imóvel (SNCR)</option>
              </select>
            </div>
          </div>

          <div class="kv" id="kvImovel" style="margin-top:12px;">
            <div class="k">Certificação SIGEF</div><div id="kv_sigef">—</div>
            <div class="k">Status</div><div id="kv_status">—</div>
            <div class="k">Área total do imóvel (ha)</div><div id="kv_area">—</div>
            <div class="k">Denominação</div><div id="kv_denom">—</div>
            <div class="k">CNS</div><div id="kv_cns">—</div>
            <div class="k">Matrícula</div><div id="kv_matricula">—</div>
          </div>
        </div>

        <!-- Anexação de Lotes do Beneficiário -->
        <div class="form-section">
          <h5><i class="material-icons">layers</i>Lotes do Beneficiário</h5>

          <!-- Form de inclusão/edição -->
          <form id="formAddLote" onsubmit="event.preventDefault(); adicionarOuAtualizarLote();">
            <div class="grid-3">
              <div class="field">
                <label for="selectLoteAdd">Lote *</label>
                <select id="selectLoteAdd" class="browser-default">
                  <option value="" disabled selected>Selecione o lote</option>
                </select>
              </div>

              <div class="field">
                <label>Área em condomínio?</label>
                <div class="choice" style="height:44px;">
                  <label style="display:flex;align-items:center;gap:6px;">
                    <input name="condo" type="radio" value="nao" checked><span>Não</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:6px;">
                    <input name="condo" type="radio" value="sim"><span>Sim</span>
                  </label>
                </div>
              </div>

              <div class="field">
                <label for="areaLoteHa">Área a adquirir (ha)</label>
                <input id="areaLoteHa" type="text" placeholder="0,00" readonly>
              </div>
            </div>

            <div style="margin-top:8px;">
              <button id="btnAddUpdLote" type="submit" class="btn btn-add btn-square">
                <i class="material-icons left">add</i>ADICIONAR LOTE
              </button>
              <small id="flagEditLote" style="display:none; color:#b71c1c; font-weight:700; margin-left:8px;">✎ MODO EDIÇÃO</small>
            </div>
          </form>

          <!-- Tabela -->
          <div class="table-wrapper" style="margin-top:14px;">
            <table class="striped bordered">
              <thead>
                <tr>
                  <th>Denominação</th>
                  <th>SIGEF</th>
                  <th>Área (ha)</th>
                  <th>Condomínio</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tabelaLotesBenef"></tbody>
            </table>
          </div>

          <div class="grid-3" style="margin-top:12px;">
            <div class="field" style="max-width:360px;">
              <label>Total da área a ser adquirida (ha)</label>
              <div id="areaTotalAdquirida" class="static-field">—</div>
            </div>
          </div>
        </div>

        <!-- Dados Pessoais -->
        <div class="form-section">
          <h5><i class="material-icons">badge</i>Beneficiário — Dados Pessoais</h5>

          <div class="grid-3">
            <div class="field">
              <label for="bp_cpf">CPF *</label>
              <input id="bp_cpf" type="text" placeholder="000.000.000-00">
            </div>
            <div class="field"><label>Nome</label><div id="bp_nome" class="static-field">—</div></div>
            <div class="field"><label>Gênero</label><div id="bp_genero" class="static-field">—</div></div>
          </div>

          <div class="grid-3">
            <div class="field"><label>Estado civil</label><div id="bp_ec" class="static-field">—</div></div>
            <div class="field"><label>Data de nascimento</label><div id="bp_nasc" class="static-field">—</div></div>
            <div class="field"><label>NIS (PIS/PASEP)</label><div id="bp_nis" class="static-field">—</div></div>
          </div>

          <div class="grid-3">
            <div class="field"><label>Estado de naturalidade</label><div id="bp_natuf" class="static-field">—</div></div>
            <div class="field"><label>Município de naturalidade</label><div id="bp_natmun" class="static-field">—</div></div>
          </div>

          <div class="grid-3">
            <div class="field"><label>Nome do pai</label><div id="bp_pai" class="static-field">—</div></div>
            <div class="field"><label>Nome da mãe</label><div id="bp_mae" class="static-field">—</div></div>
          </div>

          <div class="grid-3">
            <div class="field">
              <label for="cadunico">Número do CadÚnico *</label>
              <input id="cadunico" type="text" placeholder="00000000000">
            </div>
            <div class="field">
              <label>Possui DAP?</label>
              <div class="choice">
                <label style="display:flex;align-items:center;gap:6px;"><input name="hasDap" type="radio" value="sim"><span>Sim</span></label>
                <label style="display:flex;align-items:center;gap:6px;"><input name="hasDap" type="radio" value="nao" checked><span>Não</span></label>
              </div>
            </div>
            <div class="field">
              <label for="numDap">Número DAP</label>
              <input id="numDap" type="text" placeholder="Informe apenas se possuir" disabled>
            </div>
          </div>

          <div class="grid-3">
            <div class="field"><label for="rg">RG *</label><input id="rg" type="text" placeholder="Documento de identificação"></div>
            <div class="field"><label for="orgao">Órgão emissor *</label><input id="orgao" type="text" placeholder="SSP, DETRAN..."></div>
            <div class="field"><label for="dataRg">Data de emissão *</label><input id="dataRg" type="text" placeholder="dd/mm/aaaa"></div>
          </div>
        </div>

        <!-- Endereço -->
        <div class="form-section">
          <h5><i class="material-icons">place</i>Endereço e Contato</h5>

          <div class="grid-3">
            <div class="field"><label for="cep">CEP *</label><input type="text" id="cep" placeholder="00000-000"></div>
            <div class="field"><label>UF *</label><div id="uf" class="static-field">—</div></div>
            <div class="field"><label>Município *</label><div id="municipio" class="static-field">—</div></div>
          </div>

          <div class="grid-3">
            <div class="field"><label>Bairro</label><div id="bairro" class="static-field">—</div></div>
            <div class="field" style="grid-column: span 2;"><label>Endereço (Rua, Qd., Lt.) *</label><div id="endereco" class="static-field">—</div></div>
          </div>

          <div class="grid-3">
            <div class="field"><label>Número *</label><input id="numero" type="text" placeholder="000"></div>
            <div class="field"><label>Complemento</label><input id="compl" type="text" placeholder="Opcional"></div>
            <div class="field"><label>Celular *</label><input id="celular" type="tel" placeholder="(00) 00000-0000"></div>
          </div>
        </div>

        <!-- Agente financeiro -->
        <div class="form-section">
          <h5><i class="material-icons">account_balance</i>Agente Financeiro de Interesse</h5>
          <div class="grid-3">
            <div class="field" style="max-width:420px;">
              <label for="agenteFinanceiro">Selecione *</label>
              <select id="agenteFinanceiro" class="browser-default" required>
                <option value="" disabled selected>Selecione</option>
                <option value="Banco do Brasil">Banco do Brasil</option>
                <option value="Banco do Nordeste">Banco do Nordeste</option>
              </select>
            </div>
          </div>
        </div>

        <div style="margin:12px 0; display:flex; gap:8px; justify-content:flex-end;">
          <button id="btnLimpar" class="btn btn-danger btn-square waves-effect">
            <i class="material-icons left">clear</i>Limpar (Etapa 1)
          </button>
          <button id="btnSalvar" class="btn btn-add btn-square waves-effect">
            <i class="material-icons left">save</i>SALVAR
          </button>
          <a id="btnProximo" href="beneficiario-etapa2.html" class="btn btn-add btn-square waves-effect">
            <i class="material-icons left">arrow_forward</i>PRÓXIMO
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  /* ===== Helpers ===== */
  function getJSON(key, fallback){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):fallback; }catch(e){ return fallback; } }
  function setJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function toast(txt, tipo="sucesso"){ const box=document.getElementById("mensagem"); box.textContent=txt; box.className=(tipo==="erro")?"msg-erro":"msg-sucesso"; box.style.display="block"; setTimeout(()=>box.style.display="none",3200); }
  const fmtBR = (n)=> n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});
  function parsePt(v){ if(v==null) return NaN; if(typeof v==="number") return v; const s=String(v).replace(/\./g,"").replace(",","."); const n=parseFloat(s); return isNaN(n)?NaN:n; }
  function maskCPF(v){ v=v.replace(/\D/g,"").slice(0,11); let out=""; if(v.length>0) out=v.slice(0,3); if(v.length>3) out+="."+v.slice(3,6); if(v.length>6) out+="."+v.slice(6,9); if(v.length>9) out+="-"+v.slice(9,11); return out; }
  function maskCEP(v){ v=v.replace(/\D/g,"").slice(0,8); if(v.length>5) v=v.slice(0,5)+"-"+v.slice(5); return v; }

  /* ===== Estado de imóveis/lotes ===== */
  const ctx = {
    imoveis:     getJSON("imoveis", []),
    lotes:       getJSON("lotes", []),
    desmembrado: localStorage.getItem("imovelDesmembrado")==="true",
    lotesBenef:  [] // {id, denom, sigef, areaHa, condominio}
  };

  /* ===== Imóvel ===== */
  function preencherSelectImovel(){
    const sel = document.getElementById("selectImovel");
    sel.innerHTML = '<option value="" disabled selected>Selecione o imóvel (SNCR)</option>';
    ctx.imoveis.forEach((imv, idx)=>{
      const o=document.createElement("option");
      o.value=String(idx); o.textContent=`${imv.parcelaCodigo} — ${imv.nomeArea}`;
      sel.appendChild(o);
    });

    const salvo = getJSON("beneficiario_etapa1", null);
    if (salvo && salvo.imovelIndex!=null && ctx.imoveis[salvo.imovelIndex]){
      sel.value=String(salvo.imovelIndex);
      atualizarResumoDoImovel(salvo.imovelIndex);
      // restaura lotes do beneficiário
      if (Array.isArray(salvo.lotesSelecionados)) {
        ctx.lotesBenef = salvo.lotesSelecionados;
        renderTabelaLotesBenef();
      }
      // agente
      const ag=document.getElementById("agenteFinanceiro"); if(salvo.agente) ag.value=salvo.agente;
    }
  }

  function atualizarResumoDoImovel(index){
    const imv = ctx.imoveis[index]; if(!imv) return;
    document.getElementById("kv_sigef").textContent     = imv.codigoImovel || "—";
    document.getElementById("kv_status").textContent    = imv.status || "—";
    document.getElementById("kv_area").textContent      = imv.areaHectares || "—";
    document.getElementById("kv_denom").textContent     = imv.nomeArea || "—";
    document.getElementById("kv_cns").textContent       = imv.registroCns || "—";
    document.getElementById("kv_matricula").textContent = imv.registroMatricula || "—";

    popularLotesAdd(imv);
    // limpar form de lote e tabela do beneficiário quando mudar de imóvel
    ctx.lotesBenef = [];
    renderTabelaLotesBenef();
  }

  function getLoteAreaHa(l){ const cand=l?.areaHa ?? l?.areaLote ?? l?.area ?? l?.areaLoteHa; return parsePt(cand); }

  function popularLotesAdd(imv){
    const sel=document.getElementById("selectLoteAdd");
    sel.innerHTML='<option value="" disabled selected>Selecione o lote</option>';

    if (ctx.desmembrado && ctx.lotes.length){
      // filtra por sncrRef quando existir
      let lotes = ctx.lotes;
      if (ctx.lotes[0]?.sncrRef) lotes = ctx.lotes.filter(l=>l.sncrRef===imv.parcelaCodigo);
      lotes.forEach((l,i)=>{
        const opt=document.createElement("option");
        const id=String(l.id || l.sigef || i);
        opt.value=id;
        opt.textContent=`${l.denom || l.denominacao || 'Lote'} — ${(l.sigef || '').toString()}`;
        opt.dataset.sigef = l.sigef || '';
        opt.dataset.area  = getLoteAreaHa(l);
        sel.appendChild(opt);
      });
    }else{
      // não desmembrado: lote único (usa área total do imóvel)
      const opt=document.createElement("option");
      opt.value="unico"; opt.textContent="Lote Único (Total)"; opt.dataset.sigef= imv.codigoImovel || '';
      opt.dataset.area = parsePt(imv.areaHectares);
      sel.appendChild(opt);
    }
    // reset form
    document.getElementById("areaLoteHa").value="";
    document.querySelector('input[name="condo"][value="nao"]').checked = true;
    document.getElementById("areaLoteHa").readOnly = true;
  }

// Ao escolher um lote, define a área padrão e trava/destrava conforme "condomínio"
document.getElementById("selectLoteAdd").addEventListener("change", ()=>{
  const sel = document.getElementById("selectLoteAdd");
  const opt = sel.options[sel.selectedIndex];
  const area = parseFloat(opt?.dataset?.area ?? "NaN");
  const condo = document.querySelector('input[name="condo"]:checked').value === "sim";

  // preenche a área do lote
  document.getElementById("areaLoteHa").value = isNaN(area)
    ? ""
    : area.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});

  // regra: se NÃO é condomínio, campo fica bloqueado; se SIM, campo libera edição
  document.getElementById("areaLoteHa").readOnly = !condo;
});

// Alterna editabilidade quando marcar "Área em condomínio?"
Array.from(document.querySelectorAll('input[name="condo"]')).forEach(r=>{
  r.addEventListener("change", ()=>{
    const condo = document.querySelector('input[name="condo"]:checked').value === "sim";
    const areaInput = document.getElementById("areaLoteHa");
    areaInput.readOnly = !condo;

    // se ficou bloqueado (Não), restaura a área padrão do lote selecionado
    if (!condo) {
      const sel = document.getElementById("selectLoteAdd");
      const opt = sel.options[sel.selectedIndex];
      const area = parseFloat(opt?.dataset?.area ?? "NaN");
      areaInput.value = isNaN(area)
        ? ""
        : area.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});
    }
  });
});

  /* ===== Tabela de lotes do beneficiário ===== */
  let editIndex = null;

  function adicionarOuAtualizarLote(){
    const sel=document.getElementById("selectLoteAdd");
    const val=sel.value;
    if(!val){ toast("Selecione o lote.", "erro"); return; }

    const opt=sel.options[sel.selectedIndex];
    const denom=opt.textContent.split(" — ")[0];
    const sigef=opt.dataset.sigef || "";
    const condo = document.querySelector('input[name="condo"]:checked').value==="sim";
    const areaStr=document.getElementById("areaLoteHa").value.trim();
    const areaNum=parsePt(areaStr);

    if(isNaN(areaNum) || areaNum<=0){ toast("Informe/valide a área do lote (ha).", "erro"); return; }

    // não permitir duplicar o mesmo lote (exceto quando estiver editando a mesma linha)
    const dupIndex = ctx.lotesBenef.findIndex(x=>x.id===val);
    if (dupIndex>=0 && dupIndex!==editIndex){
      toast("Este lote já foi anexado.", "erro");
      return;
    }

    const objeto = { id: val, denom, sigef, areaHa: areaNum, condominio: condo };

    if (editIndex!==null){
      ctx.lotesBenef[editIndex] = objeto;
      editIndex=null;
      document.getElementById("flagEditLote").style.display="none";
      document.getElementById("btnAddUpdLote").innerHTML = '<i class="material-icons left">add</i>ADICIONAR LOTE';
      toast("Lote atualizado.");
    } else {
      ctx.lotesBenef.push(objeto);
      toast("Lote anexado.");
    }

    renderTabelaLotesBenef();
    // limpar mini-form
    document.getElementById("formAddLote").reset();
    // reconfigura condo/área readonly
    document.querySelector('input[name="condo"][value="nao"]').checked = true;
    document.getElementById("areaLoteHa").readOnly = true;
  }

  function renderTabelaLotesBenef(){
    const tbody=document.getElementById("tabelaLotesBenef");
    tbody.innerHTML="";
    let total=0;

    ctx.lotesBenef.forEach((l,i)=>{
      total += (parseFloat(l.areaHa)||0);
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${l.denom}</td>
        <td>${l.sigef || "—"}</td>
        <td>${fmtBR(parseFloat(l.areaHa)||0)}</td>
        <td>${l.condominio ? "Sim" : "Não"}</td>
        <td>
          <button class="action-btn" title="Editar" onclick="editarLinha(${i})"><i class="material-icons">edit</i></button>
          <button class="action-btn" title="Excluir" onclick="excluirLinha(${i})"><i class="material-icons">delete</i></button>
        </td>`;
      tbody.appendChild(tr);
    });

    document.getElementById("areaTotalAdquirida").textContent = ctx.lotesBenef.length ? fmtBR(total) : "—";
  }

  window.editarLinha = function(i){
    const l=ctx.lotesBenef[i];
    editIndex=i;
    const sel=document.getElementById("selectLoteAdd");
    sel.value = l.id;
    const evt=new Event('change'); sel.dispatchEvent(evt);

    if(l.condominio) document.querySelector('input[name="condo"][value="sim"]').checked = true;
    else document.querySelector('input[name="condo"][value="nao"]').checked = true;

    document.getElementById("areaLoteHa").value = fmtBR(l.areaHa);
    document.getElementById("areaLoteHa").readOnly = !l.condominio;
    document.getElementById("flagEditLote").style.display="inline";
    document.getElementById("btnAddUpdLote").innerHTML = '<i class="material-icons left">save</i>ATUALIZAR LOTE';
  }

  window.excluirLinha = function(i){
    ctx.lotesBenef.splice(i,1);
    renderTabelaLotesBenef();
  }

  /* ===== CPF -> API fictícia ===== */
  const FAKE_DB = {
    "222.222.222-22":{
      nome:"Sebastião Mateus Melo",
      genero:"Masculino",
      ec:"Solteiro(a)",
      nasc:"22/06/1982",
      nis:"123.4567.890-1",
      natuf:"DF",
      natmun:"Brasília",
      pai:"Renato Guilherme Melo",
      mae:"Rosa Bárbara Sebastiana"
    }
  };

  const cpfInput=document.getElementById("bp_cpf");
  cpfInput.addEventListener("input",e=>{ e.target.value=maskCPF(e.target.value); });
  cpfInput.addEventListener("blur", ()=>{
    const cpf=cpfInput.value.trim();
    const d=FAKE_DB[cpf];
    if(!d){ toast("CPF não encontrado na base fictícia.", "erro"); preencherPessoa(null); return; }
    preencherPessoa(d); toast("Dados preenchidos via API fictícia.");
  });

  function preencherPessoa(d){
    const dash="—";
    document.getElementById("bp_nome").textContent   = d?.nome   || dash;
    document.getElementById("bp_genero").textContent = d?.genero || dash;
    document.getElementById("bp_ec").textContent     = d?.ec     || dash;
    document.getElementById("bp_nasc").textContent   = d?.nasc   || dash;
    document.getElementById("bp_nis").textContent    = d?.nis    || dash;
    document.getElementById("bp_natuf").textContent  = d?.natuf  || dash;
    document.getElementById("bp_natmun").textContent = d?.natmun || dash;
    document.getElementById("bp_pai").textContent    = d?.pai    || dash;
    document.getElementById("bp_mae").textContent    = d?.mae    || dash;
  }

  /* ===== DAP habilita/desabilita número ===== */
  Array.from(document.querySelectorAll('input[name="hasDap"]')).forEach(r=>{
    r.addEventListener("change",(e)=>{
      const en = e.target.value==="sim";
      const num=document.getElementById("numDap");
      num.disabled=!en; if(!en) num.value="";
    });
  });

  /* ===== CEP fictício ===== */
  const fakeCepDB = {
    "70000-000": { uf:"DF", municipio:"Brasília", bairro:"Asa Norte", endereco:"SQN 305 Bloco B" },
    "01000-000": { uf:"SP", municipio:"São Paulo", bairro:"Sé", endereco:"Praça da Sé" },
    "35930-050": { uf:"MG", municipio:"João Monlevade", bairro:"Alvorada", endereco:"Rua Lavras" }
  };
  const cepInput=document.getElementById("cep");
  cepInput.addEventListener("input",e=> e.target.value = maskCEP(e.target.value));
  cepInput.addEventListener("blur", ()=>{
    const cep=cepInput.value.trim();
    const info=fakeCepDB[cep];
    if(!info){ toast("CEP não encontrado (fictício).", "erro"); return; }
    document.getElementById("uf").textContent = info.uf;
    document.getElementById("municipio").textContent = info.municipio;
    document.getElementById("bairro").textContent = info.bairro;
    document.getElementById("endereco").textContent = info.endereco;
  });

  /* ===== Salvar & Limpar ===== */
  function salvar(){
    const ag=document.getElementById("agenteFinanceiro").value;
    const imvIdxStr=document.getElementById("selectImovel").value;
    if(!imvIdxStr){ toast("Selecione o imóvel (SNCR).", "erro"); return; }
    if(!ag){ toast("Selecione o agente financeiro.", "erro"); return; }
    if(!ctx.lotesBenef.length){ toast("Anexe pelo menos um lote do beneficiário.", "erro"); return; }

    const imvIdx=parseInt(imvIdxStr,10);
    const imv=ctx.imoveis[imvIdx];

    const totalArea = ctx.lotesBenef.reduce((s,x)=> s + (parseFloat(x.areaHa)||0), 0);

    const payload={
      imovelIndex: imvIdx,
      sncr: imv.parcelaCodigo,
      uf: imv.uf, municipio: imv.municipio,
      resumoImovel:{
        sigef: imv.codigoImovel, status: imv.status, area: imv.areaHectares,
        denom: imv.nomeArea, cns: imv.registroCns, matricula: imv.registroMatricula
      },
      lotesSelecionados: ctx.lotesBenef,
      areaAdquiridaTotalHa: totalArea,
      agente: ag,
      beneficiario:{
        cpf: document.getElementById("bp_cpf").value.trim(),
        cadunico: document.getElementById("cadunico").value.trim(),
        hasDap: document.querySelector('input[name="hasDap"]:checked').value,
        numDap: document.getElementById("numDap").value.trim(),
        rg: document.getElementById("rg").value.trim(),
        orgao: document.getElementById("orgao").value.trim(),
        dataRg: document.getElementById("dataRg").value.trim()
      },
      endereco:{
        cep: document.getElementById("cep").value.trim(),
        uf: document.getElementById("uf").textContent,
        municipio: document.getElementById("municipio").textContent,
        bairro: document.getElementById("bairro").textContent,
        logradouro: document.getElementById("endereco").textContent,
        numero: document.getElementById("numero").value.trim(),
        compl: document.getElementById("compl").value.trim(),
        celular: document.getElementById("celular").value.trim()
      }
    };

    setJSON("beneficiario_etapa1", payload);
    toast("Etapa 1 salva.");
  }

  function limpar(){
    localStorage.removeItem("beneficiario_etapa1");
    document.getElementById("selectImovel").value="";
    ["kv_sigef","kv_status","kv_area","kv_denom","kv_cns","kv_matricula"].forEach(id=> document.getElementById(id).textContent="—");
    document.getElementById("selectLoteAdd").innerHTML='<option value="" disabled selected>Selecione o lote</option>';
    ctx.lotesBenef = []; renderTabelaLotesBenef();

    // pessoais
    document.getElementById("bp_cpf").value=""; preencherPessoa(null);
    document.getElementById("cadunico").value="";
    document.querySelector('input[name="hasDap"][value="nao"]').checked=true;
    document.getElementById("numDap").value=""; document.getElementById("numDap").disabled=true;
    document.getElementById("rg").value=""; document.getElementById("orgao").value=""; document.getElementById("dataRg").value="";
    // endereço
    document.getElementById("cep").value="";
    ["uf","municipio","bairro","endereco"].forEach(id=> document.getElementById(id).textContent="—");
    document.getElementById("numero").value=""; document.getElementById("compl").value=""; document.getElementById("celular").value="";
    document.getElementById("agenteFinanceiro").value="";
    // mini-form de lote
    document.getElementById("formAddLote").reset();
    document.querySelector('input[name="condo"][value="nao"]').checked = true;
    document.getElementById("areaLoteHa").value=""; document.getElementById("areaLoteHa").readOnly = true;

    toast("Etapa 1 limpa.");
  }

  /* ===== Eventos ===== */
  document.getElementById("selectImovel").addEventListener("change", e=> atualizarResumoDoImovel(e.target.value));
  document.getElementById("btnSalvar").addEventListener("click", salvar);
  document.getElementById("btnLimpar").addEventListener("click", limpar);

  /* ===== Init ===== */
  document.addEventListener("DOMContentLoaded", ()=>{
    if(!ctx.imoveis.length){ toast("Nenhum imóvel encontrado. Volte e cadastre o imóvel.", "erro"); }
    preencherSelectImovel();
  });
</script>
</body>
</html>
