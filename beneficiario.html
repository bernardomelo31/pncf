<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>[MDA] Obter Crédito Fundiário - Beneficiário (Etapa 1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>

  <style>
    :root{
      --gap-x:16px;
      --gap-y:14px;
    }
    body{ background:#fafafa; padding:20px; }
    .btn-square{ border-radius:0 !important; }
    .btn-add{ background:#1976d2 !important; color:#fff !important; }
    .btn-danger{ background:#b71c1c !important; color:#fff !important; }
    .card-titlebar{ margin:0; line-height:1.5; background:#1976d2; color:#fff; padding:10px; text-align:center; }

    .form-section{ margin-top:1.2rem; padding:1rem; background:#fff; border:1px solid #ddd; border-radius:6px; }
    .form-section h5{ margin:0 0 .8rem 0; color:#1976d2; display:flex; align-items:center; gap:8px; }

    /* Grid consistente (sem brigar com Materialize) */
    .row{ display:flex; flex-wrap:wrap; gap:var(--gap-y) var(--gap-x); margin-bottom:0; }
    .form__input{ flex:1 1 260px; min-width:240px; }
    .form__input label{ display:block; margin-bottom:4px; font-weight:600; color:#444; }
    .mb{ margin-bottom:var(--gap-y); }

    .static-field{
      height:44px; display:flex; align-items:center; padding:0 12px;
      border:1px solid #cfd8dc; border-radius:4px; background:#f7f9fc; color:#37474f; font-weight:600;
    }
    .form__input select.browser-default,
    .form__input input[type="text"],
    .form__input input[type="tel"]{
      height:44px !important; line-height:44px !important; border:1px solid #cfd8dc !important;
      border-radius:4px !important; background:#fff !important; padding:0 10px !important;
    }

    #mensagem{ display:none; padding:10px; border-radius:6px; font-weight:600; margin:12px 0; }
    .msg-sucesso{ background:#c8e6c9; color:#256029; }
    .msg-erro{ background:#ffcdd2; color:#b71c1c; }

    /* Key/Value “Resumo” */
    .kv{ display:grid; grid-template-columns: 220px 1fr; gap:8px 14px; }
    .kv div{ padding:10px; border:1px solid #e0e0e0; border-radius:6px; background:#fafcfe; }
    .kv .k{ font-weight:700; color:#455a64; background:#f3f7fb; }
  </style>
</head>
<body>

<div class="container content">
  <div class="card">
    <div class="card-content" style="padding:0;">
      <h2 class="card-titlebar">Obter Crédito Fundiário — Beneficiário</h2>

      <div style="text-align:center; color:#145aa3; padding:.6rem;">
        <i class="material-icons" style="font-size:24px; vertical-align:middle;">label_important</i>
        <b>ETAPA 1</b>
      </div>

      <div class="section" style="padding:0 16px 16px 16px;">

        <div id="mensagem"></div>

        <!-- Seleção inicial -->
        <div class="form-section">
          <h5><i class="material-icons">home</i>Seleção do Imóvel e Lote</h5>

          <div class="row">
            <div class="form__input">
              <label for="selectImovel">Imóvel (SNCR) *</label>
              <select id="selectImovel" class="browser-default" required>
                <option value="" disabled selected>Selecione o imóvel (SNCR)</option>
              </select>
            </div>
            <div class="form__input" id="wrapLote" style="display:none;">
              <label for="selectLote">Lote *</label>
              <select id="selectLote" class="browser-default">
                <option value="" disabled selected>Selecione o lote</option>
              </select>
            </div>
          </div>

          <div id="notaLoteUnico" class="static-field mb" style="display:none;">
            Imóvel não desmembrado: lote único (Total).
          </div>
        </div>

        <!-- Resumo do imóvel -->
        <div class="form-section">
          <h5><i class="material-icons">summarize</i>Resumo do Imóvel Selecionado</h5>

          <div class="row">
            <div class="form__input"><label>UF de referência</label><div id="ufRef"  class="static-field">—</div></div>
            <div class="form__input"><label>Município de referência</label><div id="munRef" class="static-field">—</div></div>
          </div>

          <div class="kv" id="kvImovel" style="margin-top:8px;">
            <div class="k">Certificação SIGEF</div><div id="kv_sigef">—</div>
            <div class="k">Status</div><div id="kv_status">—</div>
            <div class="k">Área (ha)</div><div id="kv_area">—</div>
            <div class="k">Denominação</div><div id="kv_denom">—</div>
            <div class="k">CNS</div><div id="kv_cns">—</div>
            <div class="k">Matrícula</div><div id="kv_matricula">—</div>
          </div>

          <div id="boxResumoLote" style="display:none; margin-top:12px;">
            <h6 style="color:#1976d2; margin:0 0 6px 0;">Resumo do Lote</h6>
            <div class="kv">
              <div class="k">Denominação</div><div id="lot_denom">—</div>
              <div class="k">SIGEF</div><div id="lot_sigef">—</div>
              <div class="k">Data de entrada</div><div id="lot_data">—</div>
              <div class="k">Responsável Técnico(a)</div><div id="lot_resp">—</div>
              <div class="k">Documento de RT</div><div id="lot_rt">—</div>
              <div class="k">Status</div><div id="lot_status">—</div>

              <div class="k">Área a ser adquirida (ha)</div><div id="lot_area">—</div> <!-- NOVO: somente leitura -->
            </div>
          </div>
        </div>

        <!-- Agente financeiro -->
        <div class="form-section">
          <h5><i class="material-icons">account_balance</i>Agente Financeiro de Interesse</h5>
          <div class="row">
            <div class="form__input">
              <label for="agenteFinanceiro">Selecione *</label>
              <select id="agenteFinanceiro" class="browser-default" required>
                <option value="" disabled selected>Selecione</option>
                <option value="Banco do Brasil">Banco do Brasil</option>
                <option value="Banco do Nordeste">Banco do Nordeste</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Documentos / DAP / Endereço (mock + entradas do usuário) -->
        <div class="form-section">
          <h5><i class="material-icons">person</i>Dados do Beneficiário</h5>

          <div class="row">
            <div class="form__input">
              <label for="cadunico">Número do CadÚnico *</label>
              <input type="text" id="cadunico" placeholder="0000000000">
            </div>
            <div class="form__input">
              <label>Possui DAP?</label>
              <div class="static-field" style="gap:14px;">
                <label style="display:flex;align-items:center;gap:6px;"><input name="hasDap" type="radio" value="sim"><span>Sim</span></label>
                <label style="display:flex;align-items:center;gap:6px;"><input name="hasDap" type="radio" value="nao" checked><span>Não</span></label>
              </div>
            </div>
            <div class="form__input">
              <label for="numDap">Número DAP</label>
              <input type="text" id="numDap" placeholder="Informe apenas se possuir">
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label for="rg">RG *</label>
              <input type="text" id="rg" placeholder="Documento de identificação">
            </div>
            <div class="form__input">
              <label for="orgao">Órgão emissor *</label>
              <input type="text" id="orgao" placeholder="SSP, DETRAN...">
            </div>
            <div class="form__input">
              <label for="emissao">Data de emissão *</label>
              <input type="text" id="emissao" placeholder="dd/mm/aaaa">
            </div>
          </div>
        </div>

        <!-- Endereço & Contato (CEP auto preenche mock) -->
        <div class="form-section">
          <h5><i class="material-icons">location_on</i>Endereço e Contato</h5>

          <div class="row">
            <div class="form__input">
              <label for="cep">CEP *</label>
              <input type="text" id="cep" placeholder="00000-000">
            </div>
            <div class="form__input">
              <label for="uf">UF *</label>
              <div id="uf" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label for="municipio">Município *</label>
              <div id="municipio" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label for="bairro">Bairro</label>
              <div id="bairro" class="static-field">—</div>
            </div>
            <div class="form__input" style="flex:2 1 400px;">
              <label for="endereco">Endereço (Rua, Qd., Lt.) *</label>
              <div id="endereco" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label for="numero">Número *</label>
              <input type="text" id="numero" placeholder="000">
            </div>
            <div class="form__input">
              <label for="complemento">Complemento</label>
              <input type="text" id="complemento" placeholder="Opcional">
            </div>
            <div class="form__input">
              <label for="celular">Celular *</label>
              <input type="tel" id="celular" placeholder="(00) 00000-0000">
            </div>
          </div>
        </div>

        <div class="right-align" style="margin:12px 0; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="btnLimpar" class="btn btn-danger btn-square waves-effect" type="button">
            <i class="material-icons left">refresh</i>LIMPAR FORMULÁRIO
          </button>
          <a href="index.html" class="btn btn-danger btn-square waves-effect">
            <i class="material-icons left">arrow_back</i>VOLTAR
          </a>
          <button id="btnSalvar" class="btn btn-add btn-square waves-effect" type="button">
            <i class="material-icons left">save</i>SALVAR
          </button>
          <a id="btnProximo" href="beneficiario-etapa2.html" class="btn btn-add btn-square waves-effect">
            <i class="material-icons left">arrow_forward</i>PRÓXIMO
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  /* util localStorage */
  const getJSON = (k, fb) => { try{ const r = localStorage.getItem(k); return r? JSON.parse(r): fb; }catch(e){ return fb; } };
  const setJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));

  const ctx = {
    imoveis:     getJSON("imoveis", []),
    lotes:       getJSON("lotes", []),
    desmembrado: localStorage.getItem("imovelDesmembrado") === "true",
    laudo:       getJSON("laudo_avaliacao_completo_v1", null)
  };

  const $ = sel => document.querySelector(sel);

  function toast(txt, tipo="sucesso"){
    const el = $("#mensagem");
    el.textContent = txt;
    el.className = (tipo==="erro")? "msg-erro" : "msg-sucesso";
    el.style.display = "block";
    setTimeout(()=> el.style.display="none", 3000);
  }

  /* SELECT IMÓVEL */
  function preencherSelectImovel(){
    const sel = $("#selectImovel");
    sel.innerHTML = '<option value="" disabled selected>Selecione o imóvel (SNCR)</option>';
    ctx.imoveis.forEach((imv, i)=>{
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = `${imv.parcelaCodigo} — ${imv.nomeArea}`;
      sel.appendChild(o);
    });

    const salvo = getJSON("beneficiario_etapa1", null);
    if (salvo && salvo.imovelIndex != null && ctx.imoveis[salvo.imovelIndex]){
      sel.value = String(salvo.imovelIndex);
      atualizarResumoDoImovel(salvo.imovelIndex);

      // restauro lote se aplicável
      if ($("#wrapLote").style.display !== "none" && salvo.loteSelecionado?.id){
        $("#selectLote").value = salvo.loteSelecionado.id;
        onChangeLote(); // também preenche área a ser adquirida
      }

      // agente
      if (salvo.agente) $("#agenteFinanceiro").value = salvo.agente;
    }
  }

  function atualizarResumoDoImovel(index){
    const imv = ctx.imoveis[index];
    if(!imv) return;

    $("#ufRef").textContent  = imv.uf || "—";
    $("#munRef").textContent = imv.municipio || "—";

    $("#kv_sigef").textContent     = imv.codigoImovel || "—";
    $("#kv_status").textContent    = imv.status || "—";
    $("#kv_area").textContent      = imv.areaHectares || "—";
    $("#kv_denom").textContent     = imv.nomeArea || "—";
    $("#kv_cns").textContent       = imv.registroCns || "—";
    $("#kv_matricula").textContent = imv.registroMatricula || "—";

    configurarSelecaoDeLotes(imv);
  }

  function configurarSelecaoDeLotes(imv){
    const wrap = $("#wrapLote");
    const nota = $("#notaLoteUnico");
    const sel  = $("#selectLote");
    const boxResumo = $("#boxResumoLote");

    boxResumo.style.display = "none";
    $("#lot_area").textContent = "—";

    sel.innerHTML = '<option value="" disabled selected>Selecione o lote</option>';

    let lotesFiltrados = ctx.lotes;
    if (ctx.lotes.length && ctx.lotes[0]?.sncrRef){
      lotesFiltrados = ctx.lotes.filter(l => l.sncrRef === imv.parcelaCodigo);
    }

    if (ctx.desmembrado && lotesFiltrados.length){
      wrap.style.display = "block";
      nota.style.display = "none";
      lotesFiltrados.forEach((l,i)=>{
        const opt = document.createElement("option");
        const id = l.id || l.sigef || String(i);
        opt.value = String(id);
        opt.textContent = `${l.denom || "Lote"} — ${(l.sigef||"")}`;
        sel.appendChild(opt);
      });
    } else {
      wrap.style.display = "none";
      nota.style.display = "block";

      // área a ser adquirida quando NÃO desmembrado
      const area = (ctx.laudo?.readonly?.areaAdquirida) || imv.areaHectares || "";
      $("#boxResumoLote").style.display = "block";
      $("#lot_denom").textContent  = "Lote Único (Total)";
      $("#lot_sigef").textContent  = imv.codigoImovel || "—";
      $("#lot_data").textContent   = "—";
      $("#lot_resp").textContent   = "—";
      $("#lot_rt").textContent     = "—";
      $("#lot_status").textContent = imv.status || "—";
      $("#lot_area").textContent   = area || "—";
    }
  }

  function onChangeLote(){
    const chosenId = $("#selectLote").value;
    if(!chosenId) return;
    const imvIdx = parseInt($("#selectImovel").value, 10);
    const imv = ctx.imoveis[imvIdx];

    let lot = ctx.lotes.find(l => String(l.id || l.sigef) === chosenId);
    if(!lot && ctx.lotes[0]?.sncrRef){
      lot = ctx.lotes.find(l => l.sncrRef === imv.parcelaCodigo && String(l.id || l.sigef) === chosenId);
    }
    if(!lot) return;

    $("#boxResumoLote").style.display = "block";
    $("#lot_denom").textContent  = lot.denom || "—";
    $("#lot_sigef").textContent  = lot.sigef || "—";
    $("#lot_data").textContent   = lot.dataEntrada || "—";
    $("#lot_resp").textContent   = lot.responsavel || "—";
    $("#lot_rt").textContent     = lot.docRT || "—";
    $("#lot_status").textContent = lot.status || "—";

    // Área a ser adquirida (do lote)
    $("#lot_area").textContent   = (lot.areaHa != null ? String(lot.areaHa) : "—");
  }

  /* CEP → endereço fictício */
  const CEP_FAKE = {
    "70000-000": { uf:"DF", municipio:"Brasília", bairro:"Asa Norte", endereco:"SQN 409 Bl. A" },
    "50000-000": { uf:"PE", municipio:"Recife",   bairro:"Boa Vista", endereco:"Rua das Flores, 123" },
  };
  $("#cep").addEventListener("blur", ()=>{
    const v = $("#cep").value.trim();
    const d = CEP_FAKE[v] || CEP_FAKE["50000-000"];
    $("#uf").textContent        = d.uf;
    $("#municipio").textContent = d.municipio;
    $("#bairro").textContent    = d.bairro;
    $("#endereco").textContent  = d.endereco;
  });

  /* SALVAR */
  function salvar(){
    const ag = $("#agenteFinanceiro").value;
    const imvIdxStr = $("#selectImovel").value;
    if(!imvIdxStr){ toast("Selecione o imóvel (SNCR).", "erro"); return; }
    if(!ag){ toast("Selecione o agente financeiro.", "erro"); return; }

    const imvIdx = parseInt(imvIdxStr, 10);
    const imv = ctx.imoveis[imvIdx];

    let loteSelecionado = null;
    let areaAqu = null;

    if (ctx.desmembrado){
      const sel = $("#selectLote").value;
      if (!sel){ toast("Selecione o lote.", "erro"); return; }
      let lot = ctx.lotes.find(l => String(l.id || l.sigef) === sel);
      if(!lot && ctx.lotes[0]?.sncrRef){
        lot = ctx.lotes.find(l => l.sncrRef === imv.parcelaCodigo && String(l.id || l.sigef) === sel);
      }
      loteSelecionado = {
        id: String(lot?.id || lot?.sigef || ""),
        denom: lot?.denom || "",
        sigef: lot?.sigef || "",
        dataEntrada: lot?.dataEntrada || "",
        responsavel: lot?.responsavel || "",
        docRT: lot?.docRT || "",
        status: lot?.status || "",
        areaHa:  (lot?.areaHa ?? null)
      };
      areaAqu = lot?.areaHa ?? null;
    } else {
      loteSelecionado = { id:"unico", denom:"Lote Único (Total)" };
      areaAqu = (ctx.laudo?.readonly?.areaAdquirida) || imv.areaHectares || null;
    }

    const payload = {
      imovelIndex: imvIdx,
      sncr: imv.parcelaCodigo,
      uf: imv.uf, municipio: imv.municipio,
      resumoImovel: {
        sigef: imv.codigoImovel, status: imv.status, area: imv.areaHectares,
        denom: imv.nomeArea, cns: imv.registroCns, matricula: imv.registroMatricula
      },
      loteSelecionado,
      areaAdquirida: areaAqu,     // <- guardado também aqui
      agente: ag
    };
    setJSON("beneficiario_etapa1", payload);
    toast("Etapa 1 salva.");
  }

  /* LIMPAR */
  function limpar(){
    localStorage.removeItem("beneficiario_etapa1");
    // campos simples
    ["selectImovel","selectLote","agenteFinanceiro","cadunico","numDap","rg","orgao","emissao","cep","numero","complemento","celular"].forEach(id=>{
      const el = document.getElementById(id); if (el) el.value = "";
    });
    // reset estáticos
    ["uf","municipio","bairro","endereco","ufRef","munRef","kv_sigef","kv_status","kv_area","kv_denom","kv_cns","kv_matricula",
     "lot_denom","lot_sigef","lot_data","lot_resp","lot_rt","lot_status","lot_area"].forEach(id=>{ const el = document.getElementById(id); if(el) el.textContent="—"; });

    $("#boxResumoLote").style.display = "none";
    $("#wrapLote").style.display = "none";
    $("#notaLoteUnico").style.display = "none";
    toast("Formulário limpo.");
  }

  /* Eventos */
  $("#selectImovel").addEventListener("change", e=> atualizarResumoDoImovel(e.target.value));
  $("#selectLote").addEventListener("change", onChangeLote);
  $("#btnSalvar").addEventListener("click", salvar);
  $("#btnLimpar").addEventListener("click", limpar);

  /* Init */
  document.addEventListener("DOMContentLoaded", ()=>{
    if (!ctx.imoveis.length) toast("Nenhum imóvel encontrado. Volte e cadastre o imóvel.", "erro");
    preencherSelectImovel();
  });
</script>
</body>
</html>
