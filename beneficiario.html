<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>[MDA] Obter Crédito Fundiário - Beneficiário (Etapa 1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>

  <style>
    body{ background:#fafafa; padding:20px; }
    .btn-square{ border-radius:0 !important; }
    .btn-add{ background:#1976d2 !important; color:#fff !important; }
    .btn-danger{ background:#b71c1c !important; color:#fff !important; }
    .card-titlebar{ margin:0; line-height:1.5; background:#1976d2; color:#fff; padding:10px; text-align:center; }

    .form-section{ margin-top:1.2rem; padding:1rem; background:#fff; border:1px solid #ddd; border-radius:6px; }
    .form-section h5{ margin:0 0 .8rem 0; color:#1976d2; display:flex; align-items:center; gap:8px; }

    .row{ display:flex; flex-wrap:wrap; gap:16px; }
    .form__input{ flex:1; min-width:240px; }
    .form__input label{ display:block; margin-bottom:4px; font-weight:600; color:#444; }

    .static-field{
      height:44px; display:flex; align-items:center; padding:0 12px;
      border:1px solid #cfd8dc; border-radius:4px; background:#f7f9fc; color:#37474f; font-weight:600;
    }
    .form__input input,.form__input select.browser-default{
      height:44px !important; line-height:44px !important; border:1px solid #cfd8dc !important;
      border-radius:4px !important; background:#fff !important; padding:0 10px !important;
    }

    #mensagem{ display:none; padding:10px; border-radius:6px; font-weight:600; margin:12px 0; }
    .msg-sucesso{ background:#c8e6c9; color:#256029; }
    .msg-erro{ background:#ffcdd2; color:#b71c1c; }

    .kv{ display:grid; grid-template-columns: 200px 1fr; gap:6px 12px; }
    .kv div{ padding:6px 10px; border:1px solid #e0e0e0; border-radius:6px; background:#fafcfe; }
    .kv .k{ font-weight:700; color:#455a64; background:#f3f7fb; }
  </style>
</head>
<body>

<div class="container content">
  <div class="card">
    <div class="card-content" style="padding:0;">
      <h2 class="card-titlebar">Obter Crédito Fundiário — Beneficiário</h2>

      <div style="text-align:center; color:#145aa3; padding:.6rem;">
        <i class="material-icons" style="font-size:24px; vertical-align:middle;">label_important</i>
        <b>ETAPA 1</b>
      </div>

      <div class="section" style="padding:0 16px 16px 16px;">

        <div id="mensagem"></div>

        <!-- Seleção inicial (recupera do imoveis.html) -->
        <div class="form-section">
          <h5><i class="material-icons">home</i>Seleção do Imóvel e Lote</h5>

          <div class="row">
            <div class="form__input">
              <label for="selectImovel">Imóvel (SNCR) *</label>
              <select id="selectImovel" class="browser-default" required>
                <option value="" disabled selected>Selecione o imóvel (SNCR)</option>
              </select>
            </div>
            <div class="form__input" id="wrapLote" style="display:none;">
              <label for="selectLote">Lote *</label>
              <select id="selectLote" class="browser-default">
                <option value="" disabled selected>Selecione o lote</option>
              </select>
            </div>
            <div class="form__input">
              <label>Área a ser adquirida (ha)</label>
              <div id="areaAdquirida" class="static-field">—</div>
            </div>
          </div>

          <div id="notaLoteUnico" class="static-field" style="display:none; margin-top:6px;">
            Imóvel não desmembrado: lote único (Total).
          </div>
        </div>

        <!-- Resumo do imóvel -->
        <div class="form-section">
          <h5><i class="material-icons">summarize</i>Resumo do Imóvel Selecionado</h5>

          <div class="row">
            <div class="form__input"><label>UF de referência</label><div id="ufRef"  class="static-field">—</div></div>
            <div class="form__input"><label>Município de referência</label><div id="munRef" class="static-field">—</div></div>
          </div>

          <div class="kv" id="kvImovel" style="margin-top:8px;">
            <div class="k">Certificação SIGEF</div><div id="kv_sigef">—</div>
            <div class="k">Status</div><div id="kv_status">—</div>
            <div class="k">Área (ha)</div><div id="kv_area">—</div>
            <div class="k">Denominação</div><div id="kv_denom">—</div>
            <div class="k">CNS</div><div id="kv_cns">—</div>
            <div class="k">Matrícula</div><div id="kv_matricula">—</div>
          </div>

          <div id="boxResumoLote" style="display:none; margin-top:12px;">
            <h6 style="color:#1976d2; margin:0 0 6px 0;">Resumo do Lote</h6>
            <div class="kv">
              <div class="k">Denominação</div><div id="lot_denom">—</div>
              <div class="k">SIGEF</div><div id="lot_sigef">—</div>
              <div class="k">Data de entrada</div><div id="lot_data">—</div>
              <div class="k">Responsável Técnico(a)</div><div id="lot_resp">—</div>
              <div class="k">Documento de RT</div><div id="lot_rt">—</div>
              <div class="k">Status</div><div id="lot_status">—</div>
            </div>
          </div>
        </div>

        <!-- Agente financeiro -->
        <div class="form-section">
          <h5><i class="material-icons">account_balance</i>Agente Financeiro de Interesse</h5>
          <div class="row">
            <div class="form__input">
              <label for="agenteFinanceiro">Selecione *</label>
              <select id="agenteFinanceiro" class="browser-default" required>
                <option value="" disabled selected>Selecione</option>
                <option value="Banco do Brasil">Banco do Brasil</option>
                <option value="Banco do Nordeste">Banco do Nordeste</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Dados Pessoais -->
        <div class="form-section">
          <h5><i class="material-icons">badge</i>Beneficiário — Dados Pessoais</h5>

          <div class="row">
            <div class="form__input">
              <label for="cpf">CPF *</label>
              <input id="cpf" type="text" placeholder="000.000.000-00">
            </div>
            <div class="form__input">
              <label>Nome</label>
              <div id="nome" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>Gênero</label>
              <div id="genero" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label>Estado civil</label>
              <div id="estadoCivil" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>Data de nascimento</label>
              <div id="nascimento" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>NIS (PIS/PASEP)</label>
              <div id="nis" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label>Estado de naturalidade</label>
              <div id="natUF" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>Município de naturalidade</label>
              <div id="natMun" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label>Nome do pai</label>
              <div id="nomePai" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>Nome da mãe</label>
              <div id="nomeMae" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label for="cadunico">Número do CadÚnico *</label>
              <input id="cadunico" type="text" placeholder="00000000000">
            </div>
            <div class="form__input">
              <label>Possui DAP?</label>
              <div class="static-field" style="gap:18px;">
                <label style="display:flex;align-items:center;gap:6px;">
                  <input class="with-gap" type="radio" name="temDAP" value="sim"><span>Sim</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input class="with-gap" type="radio" name="temDAP" value="nao" checked><span>Não</span>
                </label>
              </div>
            </div>
            <div class="form__input">
              <label for="numeroDAP">Número DAP</label>
              <input id="numeroDAP" type="text" placeholder="Informe apenas se possuir" disabled>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label for="rg">RG *</label>
              <input id="rg" type="text" placeholder="Documento de identificação">
            </div>
            <div class="form__input">
              <label for="orgao">Órgão emissor *</label>
              <input id="orgao" type="text" placeholder="SSP, DETRAN...">
            </div>
            <div class="form__input">
              <label for="emissao">Data de emissão *</label>
              <input id="emissao" type="date">
            </div>
          </div>
        </div>

        <!-- Cônjuge (apenas se casado/união estável) -->
        <div id="secConjuge" class="form-section" style="display:none;">
          <h5><i class="material-icons">diversity_2</i>Dados do Cônjuge</h5>

          <div class="row">
            <div class="form__input">
              <label for="cpfConj">CPF do cônjuge *</label>
              <input id="cpfConj" type="text" placeholder="000.000.000-00">
            </div>
            <div class="form__input">
              <label>Nome do cônjuge</label>
              <div id="nomeConj" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>NIS do cônjuge</label>
              <div id="nisConj" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label>Data de nascimento</label>
              <div id="nascConj" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label for="rgConj">RG *</label>
              <input id="rgConj" type="text" placeholder="Documento do cônjuge">
            </div>
            <div class="form__input">
              <label for="orgaoConj">Órgão emissor *</label>
              <input id="orgaoConj" type="text">
            </div>
            <div class="form__input">
              <label for="emissaoConj">Data de emissão *</label>
              <input id="emissaoConj" type="date">
            </div>
          </div>
        </div>

        <!-- Endereço (CEP -> auto preencher) + Contato (apenas celular) -->
        <div class="form-section">
          <h5><i class="material-icons">pin_drop</i>Endereço e Contato</h5>

          <div class="row">
            <div class="form__input">
              <label for="cep">CEP *</label>
              <input id="cep" type="text" placeholder="00000-000">
            </div>
            <div class="form__input">
              <label>UF *</label>
              <div id="endUF" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>Município *</label>
              <div id="endMun" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label>Bairro</label>
              <div id="endBairro" class="static-field">—</div>
            </div>
            <div class="form__input">
              <label>Endereço (Rua, Qd., Lt.) *</label>
              <div id="endLogradouro" class="static-field">—</div>
            </div>
          </div>

          <div class="row">
            <div class="form__input">
              <label for="numeroEnd">Número *</label>
              <input id="numeroEnd" type="text" placeholder="000">
            </div>
            <div class="form__input">
              <label for="complEnd">Complemento</label>
              <input id="complEnd" type="text" placeholder="Opcional">
            </div>
            <div class="form__input">
              <label for="cel">Celular *</label>
              <input id="cel" type="text" placeholder="(00) 00000-0000">
            </div>
          </div>
        </div>

        <div class="right-align" style="margin:12px 0;">
          <a href="index.html" class="btn btn-danger btn-square waves-effect">
            <i class="material-icons left">arrow_back</i>VOLTAR
          </a>
          <button id="btnSalvar" class="btn btn-add btn-square waves-effect">
            <i class="material-icons left">save</i>SALVAR
          </button>
          <a id="btnProximo" href="beneficiario-etapa2.html" class="btn btn-add btn-square waves-effect">
            <i class="material-icons left">arrow_forward</i>PRÓXIMO
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  /* ===== helpers ===== */
  function getJSON(key, fallback){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):fallback; }catch(e){ return fallback; } }
  function setJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function toast(texto, tipo="sucesso"){
    const b=document.getElementById("mensagem");
    b.textContent=texto; b.className=(tipo==="erro")?"msg-erro":"msg-sucesso"; b.style.display="block";
    setTimeout(()=> b.style.display="none", 3500);
  }

  /* ===== contexto vindo do imoveis.html ===== */
  const ctx = {
    imoveis: getJSON("imoveis", []),
    lotes:   getJSON("lotes", []),
    desmembrado: localStorage.getItem("imovelDesmembrado")==="true"
  };

  /* ===== “APIs” fictícias ===== */
  const apiPessoa = {
    "217.844.939-53":{
      nome:"Sebastião Mateus Melo", genero:"Masculino", estadoCivil:"Casado(a)",
      nascimento:"22/06/1982", nis:"11111111111",
      natUF:"DF", natMun:"Brasília",
      pai:"Renato Guilherme Melo", mae:"Rosa Bárbara Sebastiana",
      conjugeCPF:"111.222.333-44"
    },
    "111.111.111-11":{
      nome:"João da Silva", genero:"Masculino", estadoCivil:"Solteiro(a)",
      nascimento:"01/01/1990", nis:"98765432100",
      natUF:"PE", natMun:"Recife", pai:"Carlos da Silva", mae:"Maria da Silva"
    }
  };
  const apiConjuge = {
    "111.222.333-44":{
      nome:"Renata Queiroz Melo", nis:"22233344455", nascimento:"05/03/1984"
    }
  };
  const apiCEP = {
    "35930-050": { uf:"MG", municipio:"João Monlevade", bairro:"Alvorada", logradouro:"Rua Lavras" },
    "70000-000": { uf:"DF", municipio:"Brasília", bairro:"Asa Norte", logradouro:"SQN 107 Bloco K" }
  };

  /* ===== util masks simples ===== */
  function maskCPF(v){ return v.replace(/\D/g,'').slice(0,11).replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2'); }
  function maskCEP(v){ return v.replace(/\D/g,'').slice(0,8).replace(/(\d{5})(\d)/,'$1-$2'); }
  function maskPhone(v){ return v.replace(/\D/g,'').slice(0,11).replace(/(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d{4})$/,'$1-$2'); }

  /* ===== seleção imóvel/lote + área adquirida ===== */
  function preencherSelectImovel(){
    const sel = document.getElementById("selectImovel");
    sel.innerHTML = '<option value="" disabled selected>Selecione o imóvel (SNCR)</option>';
    ctx.imoveis.forEach((imv, idx)=>{
      const o=document.createElement("option");
      o.value=String(idx);
      o.textContent=`${imv.parcelaCodigo} — ${imv.nomeArea}`;
      sel.appendChild(o);
    });

    // restaura (se já salvo)
    const salvo = getJSON("beneficiario_etapa1", null);
    if (salvo && salvo.imovelIndex!=null && ctx.imoveis[salvo.imovelIndex]){
      sel.value=String(salvo.imovelIndex);
      atualizarResumoDoImovel(salvo.imovelIndex);
      // lote
      if (document.getElementById("wrapLote").style.display!=="none"){
        const sL=document.getElementById("selectLote");
        sL.value = salvo.loteSelecionado?.id ?? "";
        if (sL.value) onChangeLote();
      }
      // agente
      const ag=document.getElementById("agenteFinanceiro");
      if (salvo.agente) ag.value=salvo.agente;
    }
  }

  function atualizarResumoDoImovel(index){
    const imv = ctx.imoveis[index]; if(!imv) return;

    // UF/Mun
    document.getElementById("ufRef").textContent = imv.uf || "—";
    document.getElementById("munRef").textContent = imv.municipio || "—";

    // resumo
    document.getElementById("kv_sigef").textContent     = imv.codigoImovel || "—";
    document.getElementById("kv_status").textContent    = imv.status || "—";
    document.getElementById("kv_area").textContent      = imv.areaHectares || "—";
    document.getElementById("kv_denom").textContent     = imv.nomeArea || "—";
    document.getElementById("kv_cns").textContent       = imv.registroCns || "—";
    document.getElementById("kv_matricula").textContent = imv.registroMatricula || "—";

    // lotes
    configurarSelecaoDeLotes(imv);

    // área adquirida (do lote se houver, senão do imóvel)
    let area = null;
    if (ctx.desmembrado && ctx.lotes.length){
      // por padrão use o primeiro até o usuário escolher
      area = Number(ctx.lotes[0].areaHa || 0) || null;
    }else{
      area = Number((imv.areaHectares||"").toString().replace(',','.')) || null;
    }
    document.getElementById("areaAdquirida").textContent = (area!=null) ? String(area).replace('.',',') : "—";
  }

  function configurarSelecaoDeLotes(imv){
    const wrap = document.getElementById("wrapLote");
    const notaUnico = document.getElementById("notaLoteUnico");
    const boxResumoLote = document.getElementById("boxResumoLote");
    const sel = document.getElementById("selectLote");

    boxResumoLote.style.display="none";
    sel.innerHTML = '<option value="" disabled selected>Selecione o lote</option>';

    // se os lotes tiverem sncrRef, filtramos por esse imóvel
    let lotesFiltrados = ctx.lotes;
    if (ctx.lotes.length && ctx.lotes[0]?.sncrRef){
      lotesFiltrados = ctx.lotes.filter(l => l.sncrRef === imv.parcelaCodigo);
    }

    if (ctx.desmembrado && lotesFiltrados.length){
      wrap.style.display="block"; notaUnico.style.display="none";
      lotesFiltrados.forEach((l,i)=>{
        const opt=document.createElement("option");
        const id = l.id || l.sigef || String(i);
        opt.value=String(id);
        opt.textContent=`${l.denom || 'Lote'} — ${l.sigef || ''}`;
        sel.appendChild(opt);
      });
    }else{
      wrap.style.display="none"; notaUnico.style.display="block";
    }
  }

  function onChangeLote(){
    const sel=document.getElementById("selectLote");
    const chosen=sel.value; if(!chosen) return;

    const imIdx=parseInt(document.getElementById("selectImovel").value,10);
    const imv=ctx.imoveis[imIdx];

    let lot = ctx.lotes.find(l => String(l.id||l.sigef)===chosen);
    if (!lot && ctx.lotes[0]?.sncrRef){
      lot = ctx.lotes.find(l => l.sncrRef===imv.parcelaCodigo && String(l.id||l.sigef)===chosen);
    }
    if(!lot) return;

    document.getElementById("boxResumoLote").style.display="block";
    document.getElementById("lot_denom").textContent  = lot.denom || "—";
    document.getElementById("lot_sigef").textContent  = lot.sigef || "—";
    document.getElementById("lot_data").textContent   = lot.dataEntrada || "—";
    document.getElementById("lot_resp").textContent   = lot.responsavel || "—";
    document.getElementById("lot_rt").textContent     = lot.docRT || "—";
    document.getElementById("lot_status").textContent = lot.status || "—";

    // área adquirida do lote
    const area = Number(lot.areaHa || 0) || null;
    document.getElementById("areaAdquirida").textContent = (area!=null) ? String(area).replace('.',',') : "—";
  }

  /* ===== Dados Pessoais via CPF ===== */
  const elCPF = document.getElementById("cpf");
  const fields = {
    nome:"nome", genero:"genero", estadoCivil:"estadoCivil", nascimento:"nascimento", nis:"nis",
    natUF:"natUF", natMun:"natMun", pai:"nomePai", mae:"nomeMae"
  };
  function preencherPessoa(data){
    document.getElementById("nome").textContent = data?.nome || "—";
    document.getElementById("genero").textContent = data?.genero || "—";
    document.getElementById("estadoCivil").textContent = data?.estadoCivil || "—";
    document.getElementById("nascimento").textContent = data?.nascimento || "—";
    document.getElementById("nis").textContent = data?.nis || "—";
    document.getElementById("natUF").textContent = data?.natUF || "—";
    document.getElementById("natMun").textContent = data?.natMun || "—";
    document.getElementById("nomePai").textContent = data?.pai || "—";
    document.getElementById("nomeMae").textContent = data?.mae || "—";

    // exibe cônjuge se casado/união estável
    const showConj = (data?.estadoCivil==="Casado(a)" || data?.estadoCivil==="União Estável");
    document.getElementById("secConjuge").style.display = showConj ? "block" : "none";

    // se tiver CPF do cônjuge, tenta preencher
    if (showConj && data?.conjugeCPF){
      document.getElementById("cpfConj").value = data.conjugeCPF;
      preencherConjugePorCPF(data.conjugeCPF);
    }
  }

  function preencherConjugePorCPF(cpf){
    const dados = apiConjuge[cpf];
    document.getElementById("nomeConj").textContent = dados?.nome || "—";
    document.getElementById("nisConj").textContent  = dados?.nis || "—";
    document.getElementById("nascConj").textContent = dados?.nascimento || "—";
  }

  elCPF.addEventListener("input", (e)=> e.target.value = maskCPF(e.target.value));
  elCPF.addEventListener("blur", ()=>{
    const d = apiPessoa[elCPF.value.trim()];
    if (!d){ toast("CPF não encontrado na base fictícia. Preencha outro.", "erro"); return; }
    preencherPessoa(d);
  });
  document.getElementById("cpfConj").addEventListener("input", (e)=> e.target.value = maskCPF(e.target.value));
  document.getElementById("cpfConj").addEventListener("blur", (e)=> preencherConjugePorCPF(e.target.value.trim()));

  // DAP enable/disable
  const radiosDAP = Array.from(document.querySelectorAll('input[name="temDAP"]'));
  radiosDAP.forEach(r => r.addEventListener('change', (e)=>{
    document.getElementById("numeroDAP").disabled = (e.target.value!=="sim");
    if (e.target.value!=="sim") document.getElementById("numeroDAP").value="";
  }));

  /* ===== Endereço via CEP ===== */
  const elCEP = document.getElementById("cep");
  elCEP.addEventListener("input", (e)=> e.target.value = maskCEP(e.target.value));
  elCEP.addEventListener("blur", ()=>{
    const d = apiCEP[elCEP.value.trim()];
    if (!d){ toast("CEP não encontrado (fictício).", "erro"); return; }
    document.getElementById("endUF").textContent = d.uf;
    document.getElementById("endMun").textContent = d.municipio;
    document.getElementById("endBairro").textContent = d.bairro;
    document.getElementById("endLogradouro").textContent = d.logradouro;
  });
  document.getElementById("cel").addEventListener("input", (e)=> e.target.value = maskPhone(e.target.value));

  /* ===== salvar ===== */
  function salvar(){
    const imIdxStr = document.getElementById("selectImovel").value;
    const ag = document.getElementById("agenteFinanceiro").value;
    if (!imIdxStr){ toast("Selecione o imóvel (SNCR).", "erro"); return; }
    if (!ag){ toast("Selecione o agente financeiro.", "erro"); return; }

    // valida pessoais mínimos
    if (!elCPF.value.trim()){ toast("Informe o CPF.", "erro"); return; }
    if (!document.getElementById("cadunico").value.trim()){ toast("Informe o número do CadÚnico.", "erro"); return; }
    if (!document.getElementById("rg").value.trim() || !document.getElementById("orgao").value.trim() || !document.getElementById("emissao").value){
      toast("Complete os documentos de identificação do beneficiário.", "erro"); return;
    }

    // endereço básico
    if (!document.getElementById("cep").value.trim() || !document.getElementById("numeroEnd").value.trim() || !document.getElementById("cel").value.trim()){
      toast("Complete CEP, número e celular.", "erro"); return;
    }

    // monta seleção lote (se houver)
    let loteSel = null;
    if (ctx.desmembrado){
      const idSel = document.getElementById("selectLote").value;
      if (!idSel){ toast("Selecione o lote.", "erro"); return; }
      let lot = ctx.lotes.find(l => String(l.id||l.sigef)===idSel);
      if (!lot && ctx.lotes[0]?.sncrRef){
        const imv=ctx.imoveis[parseInt(imIdxStr,10)];
        lot = ctx.lotes.find(l => l.sncrRef===imv.parcelaCodigo && String(l.id||l.sigef)===idSel);
      }
      loteSel = { id:String(lot?.id||lot?.sigef||""), denom:lot?.denom||"", sigef:lot?.sigef||"", areaHa:lot?.areaHa||null };
    }else{
      loteSel = { id:"unico", denom:"Lote Único (Total)" };
    }

    // salva seleção (mantendo compatibilidade com etapa anterior)
    setJSON("beneficiario_etapa1", {
      imovelIndex: parseInt(imIdxStr,10),
      agente: ag,
      loteSelecionado: loteSel
    });

    // dados pessoais
    const payload = {
      cpf: elCPF.value.trim(),
      nome: document.getElementById("nome").textContent,
      genero: document.getElementById("genero").textContent,
      estadoCivil: document.getElementById("estadoCivil").textContent,
      nascimento: document.getElementById("nascimento").textContent,
      nis: document.getElementById("nis").textContent,
      cadunico: document.getElementById("cadunico").value.trim(),
      possuiDAP: (document.querySelector('input[name="temDAP"]:checked')?.value === "sim"),
      numeroDAP: document.getElementById("numeroDAP").value.trim(),
      doc: {
        rg: document.getElementById("rg").value.trim(),
        orgao: document.getElementById("orgao").value.trim(),
        emissao: document.getElementById("emissao").value
      },
      naturalidade: {
        uf: document.getElementById("natUF").textContent,
        municipio: document.getElementById("natMun").textContent
      },
      filiacao: {
        pai: document.getElementById("nomePai").textContent,
        mae: document.getElementById("nomeMae").textContent
      },
      conjuge: (document.getElementById("secConjuge").style.display!=="none") ? {
        cpf: document.getElementById("cpfConj").value.trim(),
        nome: document.getElementById("nomeConj").textContent,
        nis: document.getElementById("nisConj").textContent,
        nascimento: document.getElementById("nascConj").textContent,
        doc: {
          rg: document.getElementById("rgConj").value.trim(),
          orgao: document.getElementById("orgaoConj").value.trim(),
          emissao: document.getElementById("emissaoConj").value
        }
      } : null,
      endereco: {
        cep: document.getElementById("cep").value.trim(),
        uf: document.getElementById("endUF").textContent,
        municipio: document.getElementById("endMun").textContent,
        bairro: document.getElementById("endBairro").textContent,
        logradouro: document.getElementById("endLogradouro").textContent,
        numero: document.getElementById("numeroEnd").value.trim(),
        complemento: document.getElementById("complEnd").value.trim()
      },
      contato: {
        celular: document.getElementById("cel").value.trim()
      },
      areaAdquiridaHa: document.getElementById("areaAdquirida").textContent
    };

    setJSON("beneficiario_pessoais", payload);
    toast("Dados do beneficiário salvos.");
  }

  /* ===== eventos ===== */
  document.getElementById("selectImovel").addEventListener("change", (e)=> atualizarResumoDoImovel(e.target.value));
  document.getElementById("selectLote").addEventListener("change", onChangeLote);
  document.getElementById("btnSalvar").addEventListener("click", salvar);

  /* ===== init ===== */
  document.addEventListener("DOMContentLoaded", ()=>{
    if (!ctx.imoveis.length){ toast("Nenhum imóvel encontrado. Volte e cadastre o imóvel.", "erro"); }
    preencherSelectImovel();
  });
</script>
</body>
</html>
