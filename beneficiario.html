<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>[MDA] Obter Crédito Fundiário - Beneficiário (Etapa 1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>

  <style>
    :root{
      --gap:16px;
      --gap-sm:12px;
      --input-h:44px;
      --bd:#cfd8dc;
    }
    body{ background:#fafafa; padding:20px; }
    .card-titlebar{ margin:0; line-height:1.5; background:#1976d2; color:#fff; padding:10px; text-align:center; }

    .btn-square{ border-radius:0 !important; }
    .btn-add{ background:#1976d2 !important; color:#fff !important; }
    .btn-danger{ background:#b71c1c !important; color:#fff !important; }

    .form-section{
      margin-top:1.2rem; padding:1rem; background:#fff; border:1px solid #ddd; border-radius:6px;
    }
    .form-section h5{ margin:0 0 .8rem 0; color:#1976d2; display:flex; align-items:center; gap:8px; }

    .row{ display:flex; flex-wrap:wrap; gap:var(--gap); margin-bottom:var(--gap); }
    .row.compact{ gap:var(--gap-sm); margin-bottom:var(--gap-sm); }
    .form__input{ flex:1 1 260px; min-width:260px; }
    .form__input label{ display:block; margin-bottom:6px; font-weight:600; color:#444; }

    .static-field{
      height:var(--input-h); display:flex; align-items:center; padding:0 12px;
      border:1px solid var(--bd); border-radius:4px; background:#f3f7fb; color:#37474f; font-weight:600;
    }
    .form__input input,
    .form__input select.browser-default,
    .form__input textarea{
      height:var(--input-h) !important; line-height:var(--input-h) !important;
      border:1px solid var(--bd) !important; border-radius:4px !important; background:#fff !important;
      padding:0 10px !important; box-sizing:border-box; margin:0 !important;
    }
    .form__input textarea{ height:auto !important; min-height:96px !important; line-height:1.5 !important; padding:8px 10px !important; }

    .kv{ display:grid; grid-template-columns: 220px 1fr; gap:8px 12px; }
    .kv div{ padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; background:#fafcfe; }
    .kv .k{ font-weight:700; color:#455a64; background:#f3f7fb; }

    .table-wrapper{ overflow-x:auto; margin-top:.5rem; }
    table.striped tbody tr:nth-child(odd){ background-color:#f9f9f9; }
    th{ font-weight:700; }

    #mensagem{ display:none; padding:10px; border-radius:6px; font-weight:600; margin:12px 0; }
    .msg-sucesso{ background:#c8e6c9; color:#256029; }
    .msg-erro{ background:#ffcdd2; color:#b71c1c; }

    .action-btn{ background:none; border:none; cursor:pointer; margin:0 4px; color:#444; }
    .action-btn .material-icons{ font-size:20px; vertical-align:middle; }

    .help-inline{ color:#607d8b; font-weight:600; }

    /* larguras utilitárias */
    .w-160{ max-width:160px; }
    .w-180{ max-width:180px; }
    .w-200{ max-width:200px; }
    .w-220{ max-width:220px; }
    .w-260{ max-width:260px; }
    .w-320{ max-width:320px; }
  </style>
</head>
<body>

<div class="container content">
  <div class="card">
    <div class="card-content" style="padding:0;">
      <h2 class="card-titlebar">Obter Crédito Fundiário — Beneficiário</h2>

      <div style="text-align:center; color:#145aa3; padding:.6rem;">
        <i class="material-icons" style="font-size:24px; vertical-align:middle;">label_important</i>
        <b>ETAPA 1</b>
      </div>

      <div class="section" style="padding:0 16px 16px 16px;">

        <div id="mensagem"></div>

        <!-- Seleção inicial: só Imóvel -->
        <div class="form-section">
          <h5><i class="material-icons">home</i>Seleção do Imóvel</h5>
          <div class="row">
            <div class="form__input w-260">
              <label for="selectImovel">Imóvel (SNCR) *</label>
              <select id="selectImovel" class="browser-default" required>
                <option value="" disabled selected>Selecione o imóvel (SNCR)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Resumo do imóvel -->
        <div class="form-section">
          <h5><i class="material-icons">summarize</i>Resumo do Imóvel Selecionado</h5>

          <div class="row">
            <div class="form__input w-260"><label>UF</label><div id="ufRef"  class="static-field">—</div></div>
            <div class="form__input"><label>Município</label><div id="munRef" class="static-field">—</div></div>
          </div>

          <div class="kv" id="kvImovel" style="margin-top:8px;">
            <div class="k">Certificação SIGEF</div><div id="kv_sigef">—</div>
            <div class="k">Status</div><div id="kv_status">—</div>
            <div class="k">Área (ha)</div><div id="kv_area">—</div>
            <div class="k">Denominação</div><div id="kv_denom">—</div>
            <div class="k">CNS</div><div id="kv_cns">—</div>
            <div class="k">Matrícula</div><div id="kv_matricula">—</div>
          </div>

          <div id="boxResumoLote" style="display:none; margin-top:12px;">
            <h6 style="color:#1976d2; margin:0 0 6px 0;">Resumo do Lote</h6>
            <div class="kv">
              <div class="k">Denominação</div><div id="lot_denom">—</div>
              <div class="k">SIGEF</div><div id="lot_sigef">—</div>
              <div class="k">Data de entrada</div><div id="lot_data">—</div>
              <div class="k">Responsável Técnico(a)</div><div id="lot_resp">—</div>
              <div class="k">Documento de RT</div><div id="lot_rt">—</div>
              <div class="k">Status</div><div id="lot_status">—</div>
              <div class="k">Área a ser adquirida (ha)</div><div id="lot_area" style="font-weight:700;">—</div>
            </div>
          </div>
        </div>

        <!-- ===== Lotes do Beneficiário (Reserva Legal/Condomínio) ===== -->
        <div class="form-section">
          <h5><i class="material-icons">view_list</i>Lotes do Beneficiário (Reserva Legal / Condomínio)</h5>

          <!-- Form de inclusão de lote -->
          <div class="row">
            <div class="form__input w-320">
              <label for="formLoteSelect">Lote *</label>
              <select id="formLoteSelect" class="browser-default">
                <option value="" disabled selected>Selecione</option>
                <!-- opções via JS -->
              </select>
            </div>

            <div class="form__input w-200">
              <label>Área em condomínio?</label>
              <div style="display:flex; align-items:center; gap:18px; height:var(--input-h);">
                <label style="display:flex; align-items:center; gap:6px; margin:0;">
                  <input class="with-gap" type="radio" name="condominio" value="nao" checked><span>Não</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; margin:0;">
                  <input class="with-gap" type="radio" name="condominio" value="sim"><span>Sim</span>
                </label>
              </div>
            </div>

            <div class="form__input w-220">
              <label for="formAreaAdquirida">Área a ser adquirida (ha)</label>
              <input type="text" id="formAreaAdquirida" placeholder="0,00" readonly>
            </div>

            <div class="form__input w-180" style="display:flex; align-items:flex-end;">
              <button id="btnAddBenefLote" class="btn btn-add btn-square" type="button">
                <i class="material-icons left">add</i>Adicionar
              </button>
            </div>
          </div>

          <!-- Tabela de lotes do beneficiário -->
          <div class="table-wrapper">
            <table class="striped bordered">
              <thead>
                <tr>
                  <th>Lote</th>
                  <th>SIGEF</th>
                  <th>Área padrão (ha)</th>
                  <th>Em condomínio?</th>
                  <th>Área a ser adquirida (ha)</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tBenefLotes"></tbody>
            </table>
          </div>
        </div>

        <!-- ===== Exploração Rural (acima do Agente Financeiro) ===== -->
        <div class="form-section">
          <h5><i class="material-icons">agriculture</i>Exploração de Imóvel Rural</h5>

          <div class="row">
            <div class="form__input w-260">
              <label>Explora algum imóvel rural?</label>
              <div style="display:flex; align-items:center; gap:18px; height:var(--input-h);">
                <label style="display:flex; align-items:center; gap:6px; margin:0;">
                  <input class="with-gap" type="radio" name="explora" value="sim">
                  <span>Sim</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; margin:0;">
                  <input class="with-gap" type="radio" name="explora" value="nao" checked>
                  <span>Não</span>
                </label>
              </div>
              <small class="help-inline">Se “Sim”, preencha abaixo os dados do estabelecimento e G.1.</small>
            </div>
          </div>

          <div id="exploraWrapper" style="display:none;">

            <div class="form-section" style="margin-top:12px;">
              <h5><i class="material-icons">assignment</i>Dados do Estabelecimento (CCIR)</h5>

              <div class="row">
                <div class="form__input w-260">
                  <label for="ccir">CCIR</label>
                  <input type="text" id="ccir" placeholder="111.111.111.111-1">
                </div>
                <div class="form__input">
                  <label for="denomEstab">Denominação do imóvel</label>
                  <input type="text" id="denomEstab">
                </div>
              </div>

              <div class="row">
                <div class="form__input">
                  <label for="localEstab">Localização do imóvel</label>
                  <input type="text" id="localEstab" placeholder="Município/Bairro/Zona Rural">
                </div>
                <div class="form__input w-220">
                  <label for="areaEstab">Área do estabelecimento (ha)</label>
                  <input type="text" id="areaEstab" placeholder="0,00">
                </div>
              </div>

              <div class="row">
                <div class="form__input w-260">
                  <label>É proprietário do imóvel principal?</label>
                  <div style="display:flex; align-items:center; gap:18px; height:var(--input-h);">
                    <label style="display:flex; align-items:center; gap:6px; margin:0;">
                      <input class="with-gap" type="radio" name="propPrin" value="sim"><span>Sim</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; margin:0;">
                      <input class="with-gap" type="radio" name="propPrin" value="nao" checked><span>Não</span>
                    </label>
                  </div>
                </div>
                <div class="form__input">
                  <label for="nomeProprietario">Nome/Razão social do proprietário</label>
                  <input type="text" id="nomeProprietario">
                </div>
                <div class="form__input w-260">
                  <label for="docProprietario">CPF/CNPJ do proprietário</label>
                  <input type="text" id="docProprietario" placeholder="CPF ou CNPJ">
                </div>
              </div>
            </div>

            <div class="form-section" style="margin-top:12px;">
              <h5><i class="material-icons">people</i>C) Características Socioeconômicas</h5>

              <div class="row">
                <div class="form__input">
                  <label for="condicaoPosse">Condição de posse e uso da terra</label>
                  <select id="condicaoPosse" class="browser-default">
                    <option value="" disabled selected>Selecione</option>
                    <option value="Proprietário">Proprietário</option>
                    <option value="Parceiro/meeiro">Parceiro/meeiro</option>
                    <option value="Arrendatário">Arrendatário</option>
                    <option value="Posse familiar">Posse familiar</option>
                    <option value="Outro">Outro</option>
                  </select>
                </div>
                <div class="form__input">
                  <label for="ativPrincipais">Atividades principais</label>
                  <select id="ativPrincipais" class="browser-default">
                    <option value="" disabled selected>Selecione</option>
                    <option value="Agricultor">Agricultor</option>
                    <option value="Pecuarista">Pecuarista</option>
                    <option value="Agricultor e Pecuarista">Agricultor e Pecuarista</option>
                    <option value="Outros">Outros</option>
                  </select>
                </div>
                <div class="form__input w-220">
                  <label for="areaExplorada">Área explorada do estabelecimento (ha)</label>
                  <input type="text" id="areaExplorada" placeholder="0,00">
                </div>
              </div>
            </div>

            <div class="form-section" style="margin-top:12px;">
              <h5><i class="material-icons">calculate</i>G.1) Resultados da Atividade Rural</h5>

              <div class="row compact">
                <div class="form__input w-260">
                  <label for="g1Ativ">Atividades Rurais</label>
                  <select id="g1Ativ" class="browser-default">
                    <option value="" disabled selected>Selecione</option>
                    <option value="Agrícola">Agrícola</option>
                    <option value="Pecuária">Pecuária</option>
                  </select>
                </div>
                <div class="form__input w-220">
                  <label for="g1Receita">Receita – R$ (A)</label>
                  <input type="text" id="g1Receita" placeholder="R$ 0,00">
                </div>
                <div class="form__input w-220">
                  <label for="g1Despesa">Despesas – R$ (B)</label>
                  <input type="text" id="g1Despesa" placeholder="R$ 0,00">
                </div>
                <div class="form__input w-180" style="display:flex; align-items:flex-end;">
                  <button id="btnAddG1" class="btn btn-add btn-square" type="button">
                    <i class="material-icons left">add</i>Adicionar
                  </button>
                </div>
              </div>

              <div class="table-wrapper">
                <table class="striped bordered">
                  <thead>
                    <tr>
                      <th>Atividades Rurais</th>
                      <th>Receita – R$ (A)</th>
                      <th>Despesas – R$ (B)</th>
                      <th>Renda Líquida (A - B)</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="tG1"></tbody>
                </table>
              </div>
            </div>
          </div><!-- /exploraWrapper -->
        </div><!-- /Exploração -->

        <!-- G.2) Benefícios sociais e previdenciários (somente tabela/API) -->
        <div class="form-section">
          <h5><i class="material-icons">volunteer_activism</i>G.2) Benefícios sociais e previdenciários</h5>
          <div class="table-wrapper">
            <table class="striped bordered">
              <thead>
                <tr><th>Tipo de benefício</th><th>Valor (R$)</th></tr>
              </thead>
              <tbody id="tG2"></tbody>
            </table>
          </div>
          <small class="help-inline">Dados carregados automaticamente (CadÚnico simulado).</small>
        </div>

        <!-- G.3) Demais Rendas -->
        <div class="form-section">
          <h5><i class="material-icons">paid</i>G.3) Demais Rendas</h5>

          <div class="row compact">
            <div class="form__input">
              <label for="g3Tipo">Tipo de renda</label>
              <select id="g3Tipo" class="browser-default">
                <option value="" disabled selected>Selecione</option>
                <option>Diárias de trabalho</option>
                <option>Serviços prestados</option>
                <option>Venda de mel</option>
                <option>Transporte local</option>
                <option>Artesanato</option>
                <option>Outros</option>
              </select>
            </div>
            <div class="form__input w-220">
              <label for="g3Valor">Valor (R$)</label>
              <input type="text" id="g3Valor" placeholder="R$ 0,00">
            </div>
            <div class="form__input w-180" style="display:flex; align-items:flex-end;">
              <button id="btnAddG3" class="btn btn-add btn-square" type="button">
                <i class="material-icons left">add</i>Adicionar
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="striped bordered">
              <thead>
                <tr><th>Tipo</th><th>Valor (R$)</th><th>Ações</th></tr>
              </thead>
              <tbody id="tG3"></tbody>
            </table>
          </div>
        </div>

        <!-- Total + Enquadramento -->
        <div class="form-section">
          <h5><i class="material-icons">analytics</i>Renda Total e Enquadramento</h5>

          <div class="row">
            <div class="form__input w-260">
              <label>Renda total anual (G.1 + G.2 + G.3)</label>
              <div id="rendaTotal" class="static-field" style="font-weight:700;">R$ 0,00</div>
            </div>

            <div class="form__input w-320">
              <label for="enquadramento">Enquadramento PNCF</label>
              <select id="enquadramento" class="browser-default">
                <option value="" disabled selected>Selecione</option>
              </select>
              <small class="help-inline">Só aparecem as opções compatíveis com a renda.</small>
            </div>
          </div>
        </div>

        <!-- Agente Financeiro -->
        <div class="form-section">
          <h5><i class="material-icons">account_balance</i>Agente Financeiro de Interesse</h5>
          <div class="row">
            <div class="form__input w-260">
              <label for="agenteFinanceiro">Selecione *</label>
              <select id="agenteFinanceiro" class="browser-default" required>
                <option value="" disabled selected>Selecione</option>
                <option value="Banco do Brasil">Banco do Brasil</option>
                <option value="Banco do Nordeste">Banco do Nordeste</option>
              </select>
            </div>
          </div>
        </div>

        <div class="right-align" style="margin:12px 0;">
          <button id="btnLimpar" class="btn btn-danger btn-square waves-effect" type="button">
            <i class="material-icons left">delete_sweep</i>LIMPAR
          </button>
          <button id="btnSalvar" class="btn btn-add btn-square waves-effect" type="button">
            <i class="material-icons left">save</i>SALVAR
          </button>
          <a id="btnProximo" href="laudo2.html" class="btn btn-add btn-square waves-effect">
            <i class="material-icons left">arrow_forward</i>PRÓXIMO
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  /* ===== Helpers ===== */
  function getJSON(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch(e){ console.warn("Falha lendo", key, e); return fallback; }
  }
  function setJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function toast(texto, tipo="sucesso"){
    const box = document.getElementById("mensagem");
    box.textContent = texto;
    box.className = (tipo==="erro") ? "msg-erro" : "msg-sucesso";
    box.style.display = "block";
    setTimeout(()=> box.style.display="none", 3500);
  }

  /* ===== BRL mask ===== */
  function formatBRLFromDigits(digits){
    digits = (digits||"").replace(/\D/g,"");
    if (!digits) return "R$ 0,00";
    if (digits.length === 1) digits = "0" + digits;
    const inteiro = digits.slice(0, -2).replace(/^0+(?=\d)/,'') || "0";
    const dec = digits.slice(-2);
    const inteiroFmt = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return `R$ ${inteiroFmt},${dec}`;
  }
  function parseBRL(v){
    if (!v) return 0;
    return parseFloat(String(v).replace(/[R$\s\.]/g,"").replace(",",".")||"0") || 0;
  }
  function attachBRLMask(el){
    el.addEventListener("input", e=>{
      const raw = e.target.value;
      const digits = raw.replace(/\D/g,"");
      e.target.value = formatBRLFromDigits(digits);
    });
    el.addEventListener("focus", e=>{ if(!e.target.value) e.target.value="R$ 0,00"; });
    el.addEventListener("blur",  e=>{ if(!e.target.value) e.target.value="R$ 0,00"; });
  }

  /* ===== Estado do imóvel/lotes vindo do imoveis.html ===== */
  const ctx = {
    imoveis:        getJSON("imoveis", []),
    lotes:          getJSON("lotes", []),
    desmembrado:    localStorage.getItem("imovelDesmembrado") === "true"
  };

  /* ===== utils hectares ===== */
  function parseHa(v){
    if (v==null) return null;
    const s = String(v).replace(/\./g,"").replace(",",".");
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }
  function formatHa(n){
    if (n==null || isNaN(n)) return "—";
    return String(n).replace(".", ",");
  }

  /* ===== Seleção de imóvel ===== */
  function preencherSelectImovel(){
    const sel = document.getElementById("selectImovel");
    sel.innerHTML = '<option value="" disabled selected>Selecione o imóvel (SNCR)</option>';
    ctx.imoveis.forEach((imv, idx)=>{
      const o = document.createElement("option");
      o.value = String(idx);
      o.textContent = `${imv.parcelaCodigo} — ${imv.nomeArea}`;
      sel.appendChild(o);
    });

    const salvo = getJSON("beneficiario_etapa1", null);
    if (salvo && salvo.imovelIndex != null && ctx.imoveis[salvo.imovelIndex]){
      sel.value = String(salvo.imovelIndex);
      atualizarResumoDoImovel(salvo.imovelIndex);
      const ag = document.getElementById("agenteFinanceiro");
      if (salvo.agente) ag.value = salvo.agente;
    }
  }

  function atualizarResumoDoImovel(index){
    const imv = ctx.imoveis[index];
    if (!imv){ return; }

    document.getElementById("ufRef").textContent = imv.uf || "—";
    document.getElementById("munRef").textContent = imv.municipio || "—";

    document.getElementById("kv_sigef").textContent     = imv.codigoImovel || "—";
    document.getElementById("kv_status").textContent    = imv.status || "—";
    document.getElementById("kv_area").textContent      = imv.areaHectares || "—";
    document.getElementById("kv_denom").textContent     = imv.nomeArea || "—";
    document.getElementById("kv_cns").textContent       = imv.registroCns || "—";
    document.getElementById("kv_matricula").textContent = imv.registroMatricula || "—";

    carregarFormLoteOptions(imv);
    atualizarResumoLoteByForm(); // inicializa resumo
  }

  /* ===== Lotes do Beneficiário (form + tabela) ===== */
  function lotesDoImovelAtual(){
    const imvIdx = parseInt(document.getElementById("selectImovel").value || "-1", 10);
    const imv = ctx.imoveis[imvIdx];
    if (!imv) return {imv:null, lotes:[]};

    if (!ctx.desmembrado || !ctx.lotes.length){
      // lote único (total)
      return {imv, lotes:[{ id:"unico", denom:"Lote Único (Total)", sigef:imv.codigoImovel, areaLoteHa: parseHa(imv.areaHectares) }]};
    }

    // Filtra por SNCR se existir referência
    let lotesFiltrados = ctx.lotes;
    if (ctx.lotes[0]?.sncrRef){
      lotesFiltrados = ctx.lotes.filter(l => l.sncrRef === imv.parcelaCodigo);
    }

    // Fallback de área: divide área total pelo nº de lotes quando faltar áreaLoteHa
    const totalHa = parseHa(imv.areaHectares);
    const n = lotesFiltrados.length || 1;
    const defCada = (totalHa!=null && n>0) ? (totalHa/n) : null;

    return {
      imv,
      lotes: lotesFiltrados.map(l => ({
        ...l,
        id: l.id || l.sigef,
        areaLoteHa: (l.areaLoteHa!=null ? parseHa(l.areaLoteHa) : defCada)
      }))
    };
  }

  function carregarFormLoteOptions(imv){
    const sel = document.getElementById("formLoteSelect");
    sel.innerHTML = '<option value="" disabled selected>Selecione</option>';

    const pack = lotesDoImovelAtual();
    pack.lotes.forEach((l, i)=>{
      const opt = document.createElement("option");
      const id = l.id || String(i);
      opt.value = String(id);
      opt.textContent = `${l.denom || 'Lote'} — ${l.sigef || ''} — ${formatHa(l.areaLoteHa)} ha`;
      sel.appendChild(opt);
    });

    // escolhe o primeiro disponível por padrão
    if (pack.lotes.length){
      sel.value = String(pack.lotes[0].id || "unico");
    }
    setAreaPadraoNoForm();
  }

  function setAreaPadraoNoForm(){
    const pack = lotesDoImovelAtual();
    const id = document.getElementById("formLoteSelect").value;
    const lot = pack.lotes.find(l => String(l.id) === String(id));
    const areaPadrao = lot ? lot.areaLoteHa : null;

    const cond = document.querySelector('input[name="condominio"]:checked')?.value === "sim";
    const areaInput = document.getElementById("formAreaAdquirida");

    if (cond){
      areaInput.readOnly = false;
      areaInput.value = (areaPadrao!=null) ? String(areaPadrao).replace(".", ",") : "";
    } else {
      areaInput.readOnly = true;
      areaInput.value = (areaPadrao!=null) ? String(areaPadrao).replace(".", ",") : "";
    }
    atualizarResumoLoteByForm();
  }

  document.getElementById("formLoteSelect").addEventListener("change", setAreaPadraoNoForm);
  Array.from(document.querySelectorAll('input[name="condominio"]')).forEach(r=>{
    r.addEventListener("change", setAreaPadraoNoForm);
  });

  function atualizarResumoLoteByForm(){
    const pack = lotesDoImovelAtual();
    const id = document.getElementById("formLoteSelect").value;
    const lot = pack.lotes.find(l => String(l.id) === String(id));

    if (!lot){
      document.getElementById("boxResumoLote").style.display = "none";
      return;
    }

    // Se já existe na tabela, mostra a área adquirida da tabela
    const match = benefLotes.find(x => x.loteId === String(lot.id));
    const areaMostrar = match ? match.areaAdquiridaHa : lot.areaLoteHa;

    document.getElementById("boxResumoLote").style.display = "block";
    document.getElementById("lot_denom").textContent  = lot.denom || "—";
    document.getElementById("lot_sigef").textContent  = lot.sigef || "—";
    document.getElementById("lot_data").textContent   = lot.dataEntrada || "—";
    document.getElementById("lot_resp").textContent   = lot.responsavel || "—";
    document.getElementById("lot_rt").textContent     = lot.docRT || "—";
    document.getElementById("lot_status").textContent = lot.status || "—";
    document.getElementById("lot_area").textContent   = (areaMostrar!=null) ? String(areaMostrar).replace(".", ",") : "—";
  }

  let benefLotes = getJSON("beneficiario_lotes_escolhidos", []); // [{loteId, denom, sigef, areaPadraoHa, condominio, areaAdquiridaHa}]
  function renderBenefLotes(){
    const tb = document.getElementById("tBenefLotes");
    tb.innerHTML = "";
    benefLotes.forEach((r, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.denom || (r.loteId==="unico" ? "Lote Único (Total)" : "Lote")}</td>
        <td>${r.sigef || "—"}</td>
        <td>${(r.areaPadraoHa!=null)? String(r.areaPadraoHa).replace(".", ",") : "—"}</td>
        <td>${r.condominio ? "Sim" : "Não"}</td>
        <td>${(r.areaAdquiridaHa!=null)? String(r.areaAdquiridaHa).replace(".", ",") : "—"}</td>
        <td>
          <button class="action-btn" title="Editar" onclick="editBenefLote(${i})"><i class="material-icons">edit</i></button>
          <button class="action-btn" title="Excluir" onclick="delBenefLote(${i})"><i class="material-icons">delete</i></button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function addBenefLote(){
    const pack = lotesDoImovelAtual();
    const id = document.getElementById("formLoteSelect").value;
    if (!id){ toast("Selecione o lote para adicionar.", "erro"); return; }

    const lot = pack.lotes.find(l => String(l.id) === String(id));
    if (!lot){ toast("Lote inválido.", "erro"); return; }

    const cond = document.querySelector('input[name="condominio"]:checked')?.value === "sim";
    const areaTxt = (document.getElementById("formAreaAdquirida").value || "").replace(",", ".");
    let areaAdq = lot.areaLoteHa;

    if (cond){
      const f = parseFloat(areaTxt);
      if (isNaN(f) || f<=0){ toast("Informe uma área válida para aquisição (ha).", "erro"); return; }
      areaAdq = f;
    }

    const novo = {
      loteId:String(lot.id), denom:lot.denom || "Lote", sigef:lot.sigef || "",
      areaPadraoHa: lot.areaLoteHa, condominio:cond, areaAdquiridaHa:areaAdq
    };

    const iExist = benefLotes.findIndex(x => x.loteId === String(lot.id));
    if (iExist >= 0) benefLotes[iExist] = novo; else benefLotes.push(novo);

    setJSON("beneficiario_lotes_escolhidos", benefLotes);
    renderBenefLotes();
    atualizarResumoLoteByForm();
    toast("Lote incluído/atualizado para o beneficiário.");
  }

  document.getElementById("btnAddBenefLote").addEventListener("click", addBenefLote);

  function editBenefLote(i){
    const r = benefLotes[i];
    if (!r) return;
    document.getElementById("formLoteSelect").value = r.loteId;
    document.querySelector(`input[name="condominio"][value="${r.condominio?'sim':'nao'}"]`).checked = true;
    document.getElementById("formAreaAdquirida").readOnly = !r.condominio;
    document.getElementById("formAreaAdquirida").value = (r.areaAdquiridaHa!=null) ? String(r.areaAdquiridaHa).replace(".", ",") : "";
    atualizarResumoLoteByForm();
    toast("Edição carregada no formulário acima.");
  }

  function delBenefLote(i){
    benefLotes.splice(i,1);
    setJSON("beneficiario_lotes_escolhidos", benefLotes);
    renderBenefLotes();
    atualizarResumoLoteByForm();
  }

  /* ===== Exploração Rural (mostrar/ocultar) ===== */
  const radiosExplora = Array.from(document.querySelectorAll('input[name="explora"]'));
  function setExploraVisible(vis){
    document.getElementById("exploraWrapper").style.display = vis ? "block" : "none";
  }
  radiosExplora.forEach(r=>{
    r.addEventListener('change', (e)=> setExploraVisible(e.target.value === 'sim'));
  });

  /* ===== CCIR auto (fictício) ===== */
  const ccirInput = document.getElementById("ccir");
  function formatarSNCR(d){
    const digits = (d||"").replace(/\D/g,"").slice(0,13);
    let out = "";
    if (digits.length > 0) out = digits.substring(0, 3);
    if (digits.length > 3) out += "." + digits.substring(3, 6);
    if (digits.length > 6) out += "." + digits.substring(6, 9);
    if (digits.length > 9) out += "." + digits.substring(9, 12);
    if (digits.length > 12) out += "-" + digits.substring(12, 13);
    return out;
  }
  ccirInput?.addEventListener("input", e => e.target.value = formatarSNCR(e.target.value));
  ccirInput?.addEventListener("blur", ()=>{
    const v = (ccirInput.value||"").trim();
    if (v === "111.111.111.111-1"){
      document.getElementById("denomEstab").value = "Sítio Boa Esperança";
      document.getElementById("localEstab").value = "Zona Rural, União - PI";
      document.getElementById("areaEstab").value  = "12,00";
      document.querySelector('input[name="propPrin"][value="sim"]').checked = true;
      document.getElementById("nomeProprietario").value = "José da Silva";
      document.getElementById("docProprietario").value  = "111.111.111-11";
      document.getElementById("condicaoPosse").value = "Proprietário";
      document.getElementById("ativPrincipais").value = "Agricultor";
      document.getElementById("areaExplorada").value = "8,00";
    }
  });

  /* ===== G.1 / G.2 / G.3 ===== */
  let g1 = []; // {ativ, receita, despesa, renda}
  let g2 = []; // {tipo, valor}
  let g3 = []; // {tipo, valor}

  const tG1 = document.getElementById("tG1");
  const tG2 = document.getElementById("tG2");
  const tG3 = document.getElementById("tG3");

  function renderG1(){
    tG1.innerHTML = "";
    g1.forEach((r, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.ativ}</td>
        <td>${formatBRLFromDigits(String(Math.round(r.receita*100))).replace("R$ ","")}</td>
        <td>${formatBRLFromDigits(String(Math.round(r.despesa*100))).replace("R$ ","")}</td>
        <td><b>${formatBRLFromDigits(String(Math.round(r.renda*100))).replace("R$ ","")}</b></td>
        <td><button class="action-btn" onclick="delG1(${i})" title="Excluir"><i class="material-icons">delete</i></button></td>
      `;
      tG1.appendChild(tr);
    });
    atualizarTotaisEEnquadramento();
  }
  function renderG2(){
    tG2.innerHTML = "";
    g2.forEach((r)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.tipo}</td><td>${formatBRLFromDigits(String(Math.round(r.valor*100))).replace("R$ ","")}</td>`;
      tG2.appendChild(tr);
    });
    atualizarTotaisEEnquadramento();
  }
  function renderG3(){
    tG3.innerHTML = "";
    g3.forEach((r, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.tipo}</td>
        <td>${formatBRLFromDigits(String(Math.round(r.valor*100))).replace("R$ ","")}</td>
        <td><button class="action-btn" onclick="delG3(${i})" title="Excluir"><i class="material-icons">delete</i></button></td>
      `;
      tG3.appendChild(tr);
    });
    atualizarTotaisEEnquadramento();
  }

  function delG1(i){ g1.splice(i,1); renderG1(); }
  function delG3(i){ g3.splice(i,1); renderG3(); }

  attachBRLMask(document.getElementById("g1Receita"));
  attachBRLMask(document.getElementById("g1Despesa"));
  attachBRLMask(document.getElementById("g3Valor"));

  document.getElementById("btnAddG1").addEventListener("click", ()=>{
    const ativ = document.getElementById("g1Ativ").value;
    const rec = parseBRL(document.getElementById("g1Receita").value);
    const des = parseBRL(document.getElementById("g1Despesa").value);
    if (!ativ){ toast("Selecione a atividade (G.1).", "erro"); return; }
    const renda = Math.max(0, rec - des);
    g1.push({ativ, receita:rec, despesa:des, renda});
    renderG1();
    document.getElementById("g1Ativ").value = "";
    document.getElementById("g1Receita").value = "R$ 0,00";
    document.getElementById("g1Despesa").value = "R$ 0,00";
  });

  document.getElementById("btnAddG3").addEventListener("click", ()=>{
    const tipo = document.getElementById("g3Tipo").value;
    const val  = parseBRL(document.getElementById("g3Valor").value);
    if (!tipo){ toast("Selecione o tipo de renda (G.3).", "erro"); return; }
    g3.push({tipo, valor:val});
    renderG3();
    document.getElementById("g3Tipo").value = "";
    document.getElementById("g3Valor").value = "R$ 0,00";
  });

  /* ===== Enquadramento dinâmico (só opções compatíveis) ===== */
  const ENQ = [
    {v:"PNCF Social", max:29117.93, label:"PNCF Social — até R$ 29.117,93"},
    {v:"PNCF Jovem",  max:58235.86, label:"PNCF Jovem — até R$ 58.235,86"},
    {v:"PNCF Mais",   max:58235.86, label:"PNCF Mais — até R$ 58.235,86"},
    {v:"PNCF Empreendedor", max:314379.46, label:"PNCF Empreendedor — até R$ 314.379,46"}
  ];
  function atualizarEnquadramentoOptions(total){
    const sel = document.getElementById("enquadramento");
    const atual = sel.value;
    sel.innerHTML = '<option value="" disabled selected>Selecione</option>';
    ENQ.filter(e => total <= e.max).forEach(e=>{
      const op = document.createElement("option");
      op.value = e.v; op.textContent = e.label;
      sel.appendChild(op);
    });
    // Restaura seleção se ainda for válida
    if (atual && ENQ.find(e=> e.v===atual && total <= e.max)){
      sel.value = atual;
    }
  }

  function atualizarTotaisEEnquadramento(){
    const somaG1 = g1.reduce((acc, r)=> acc + (r.renda||0), 0);
    const somaG2 = g2.reduce((acc, r)=> acc + (r.valor||0), 0);
    const somaG3 = g3.reduce((acc, r)=> acc + (r.valor||0), 0);
    const total = somaG1 + somaG2 + somaG3;

    document.getElementById("rendaTotal").textContent = formatBRLFromDigits(String(Math.round(total*100)));
    atualizarEnquadramentoOptions(total);
  }

  /* ===== Salvar / Limpar / Navegar ===== */
  function salvar(){
    const imvIdxStr = document.getElementById("selectImovel").value;
    if (!imvIdxStr){ toast("Selecione o imóvel (SNCR).", "erro"); return; }
    const ag = document.getElementById("agenteFinanceiro").value;
    if (!ag){ toast("Selecione o agente financeiro.", "erro"); return; }

    const imvIdx = parseInt(imvIdxStr, 10);
    const imv = ctx.imoveis[imvIdx];

    const explora = document.querySelector('input[name="explora"]:checked')?.value === "sim";
    const payloadExplora = explora ? {
      ccir: document.getElementById("ccir").value,
      denomEstab: document.getElementById("denomEstab").value,
      localEstab: document.getElementById("localEstab").value,
      areaEstab: document.getElementById("areaEstab").value,
      proprietarioPrincipal: document.querySelector('input[name="propPrin"]:checked')?.value || "nao",
      nomeProprietario: document.getElementById("nomeProprietario").value,
      docProprietario: document.getElementById("docProprietario").value,
      condicaoPosse: document.getElementById("condicaoPosse").value,
      ativPrincipais: document.getElementById("ativPrincipais").value,
      areaExplorada: document.getElementById("areaExplorada").value,
      g1, g2, g3
    } : { g2, g3 };

    const total = parseBRL(document.getElementById("rendaTotal").textContent);
    const enquadramento = document.getElementById("enquadramento").value || "";

    const payload = {
      imovelIndex: imvIdx,
      sncr: imv.parcelaCodigo,
      uf: imv.uf, municipio: imv.municipio,
      resumoImovel: {
        sigef: imv.codigoImovel, status: imv.status, area: imv.areaHectares,
        denom: imv.nomeArea, cns: imv.registroCns, matricula: imv.registroMatricula
      },
      agente: ag,
      explora,
      socioeconomia: payloadExplora,
      rendaTotal: total,
      enquadramento,
      lotesBeneficiario: benefLotes
    };

    setJSON("beneficiario_etapa1", payload);
    toast("Etapa 1 salva.");
  }

  function limpar(){
    localStorage.removeItem("beneficiario_etapa1");
    localStorage.removeItem("beneficiario_lotes_escolhidos");
    benefLotes = [];
    renderBenefLotes();

    // limpa G2 (será recriado no init)
    g1 = []; g2 = []; g3 = [];
    renderG1(); renderG2(); renderG3();
    document.getElementById("rendaTotal").textContent = "R$ 0,00";
    atualizarEnquadramentoOptions(0);
    document.getElementById("enquadramento").value = "";
    document.getElementById("agenteFinanceiro").value = "";

    // exploração
    document.querySelector('input[name="explora"][value="nao"]').checked = true;
    setExploraVisible(false);
    ["ccir","denomEstab","localEstab","areaEstab","nomeProprietario","docProprietario"].forEach(id=>{
      const el = document.getElementById(id); if (el) el.value = "";
    });
    const cp = document.getElementById("condicaoPosse"); if (cp) cp.value = "";
    const ap = document.getElementById("ativPrincipais"); if (ap) ap.value = "";
    const ae = document.getElementById("areaExplorada"); if (ae) ae.value = "";
    const ppNao = document.querySelector('input[name="propPrin"][value="nao"]'); if (ppNao) ppNao.checked = true;

    // formulário de lote
    document.getElementById("formLoteSelect").value = "";
    document.querySelector('input[name="condominio"][value="nao"]').checked = true;
    document.getElementById("formAreaAdquirida").readOnly = true;
    document.getElementById("formAreaAdquirida").value = "";

    toast("Campos e dados desta etapa foram limpos.");
  }

  document.getElementById("btnSalvar").addEventListener("click", salvar);
  document.getElementById("btnLimpar").addEventListener("click", limpar);

  document.getElementById("btnProximo").addEventListener("click", (e)=>{
    const eq = document.getElementById("enquadramento").value;
    if (!eq){
      e.preventDefault();
      toast("Selecione o enquadramento compatível com a renda para continuar.", "erro");
    }else{
      salvar();
    }
  });

  document.getElementById("selectImovel").addEventListener("change", (e)=> atualizarResumoDoImovel(e.target.value));

  /* ===== Init ===== */
  document.addEventListener("DOMContentLoaded", ()=>{
    if (!ctx.imoveis.length){
      toast("Nenhum imóvel encontrado. Volte e cadastre o imóvel.", "erro");
    }
    preencherSelectImovel();

    // G.2: CadÚnico simulado
    g2 = [{tipo:"Bolsa Família", valor:9600}];
    renderG2();
    atualizarTotaisEEnquadramento();

    // recarrega tabela de lotes do beneficiário
    renderBenefLotes();
  });
</script>
</body>
</html>
